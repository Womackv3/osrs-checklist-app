<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSRS Player Dashboard</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Cinzel:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cinzel', serif;
            background: linear-gradient(45deg, #2c1810, #3d2617);
            min-height: 100vh;
            padding: 20px;
            color: #2c1810;
        }

        /* Main Journal Container */
        .journal-container {
            max-width: 1400px;
            margin: 0 auto;
            background: linear-gradient(135deg, #8b4513, #654321);
            border-radius: 15px;
            box-shadow: 
                0 0 30px rgba(0,0,0,0.5),
                inset 0 0 20px rgba(0,0,0,0.3);
            padding: 30px;
            position: relative;
        }

        .journal-container::before {
            content: '';
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            bottom: 10px;
            border: 3px solid #654321;
            border-radius: 10px;
            pointer-events: none;
        }

        /* Open Book Layout */
        .book-pages {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            min-height: 800px;
            position: relative;
        }

        .book-pages::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, #654321, #8b4513, #654321);
            transform: translateX(-50%);
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }

        /* Individual Pages */
        .page {
            background: linear-gradient(135deg, #f4e4bc, #e8d7b0);
            border-radius: 10px;
            padding: 0;
            box-shadow: 
                inset 0 0 20px rgba(101, 67, 33, 0.1),
                0 5px 15px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
            display: flex;
        }

        .page::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(139, 69, 19, 0.1) 1px, transparent 1px),
                radial-gradient(circle at 80% 20%, rgba(139, 69, 19, 0.1) 1px, transparent 1px),
                radial-gradient(circle at 40% 40%, rgba(139, 69, 19, 0.05) 1px, transparent 1px);
            pointer-events: none;
            z-index: 1;
        }

        /* Tab System Styles */
        .tab-navigation {
            background: linear-gradient(135deg, #8b4513, #654321);
            width: 60px;
            display: flex;
            flex-direction: column;
            border-radius: 10px 0 0 10px;
            position: relative;
            z-index: 2;
        }

        .tab-button {
            background: rgba(139, 69, 19, 0.8);
            border: none;
            color: #f4e4bc;
            font-family: 'MedievalSharp', serif;
            font-size: 0.8em;
            padding: 15px 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 1px solid rgba(101, 67, 33, 0.5);
            writing-mode: vertical-lr;
            text-orientation: mixed;
            min-height: 80px;
        }

        .tab-button:hover {
            background: rgba(139, 69, 19, 1);
            transform: translateX(3px);
        }

        .tab-button.active {
            background: linear-gradient(135deg, #f4e4bc, #e8d7b0);
            color: #2c1810;
            transform: translateX(5px);
            box-shadow: 2px 0 10px rgba(0,0,0,0.3);
        }

        .tab-button:first-child {
            border-radius: 10px 0 0 0;
        }

        .tab-button:last-child {
            border-bottom: none;
            border-radius: 0 0 0 10px;
        }

        /* Tab Content Area */
        .tab-content-area {
            flex: 1;
            padding: 30px;
            position: relative;
            z-index: 2;
        }

        .tab-content {
            display: none;
            height: 100%;
            overflow-y: auto;
        }

        .tab-content.active {
            display: block;
        }

        .tab-content h1 {
            font-family: 'MedievalSharp', serif;
            font-size: 2.2em;
            color: #654321;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .tab-content h2 {
            font-family: 'MedievalSharp', serif;
            font-size: 1.5em;
            color: #8b4513;
            margin-bottom: 15px;
            border-bottom: 2px solid #d4c4a0;
            padding-bottom: 5px;
        }

        /* Left Page Specific Styles */
        .left-page .tab-content-area {
            border-radius: 0 10px 10px 0;
        }

        /* Notes Tab Styles */
        .notes-textarea {
            width: 100%;
            height: 400px;
            background: rgba(244, 228, 188, 0.8);
            border: 2px solid #8b4513;
            border-radius: 5px;
            padding: 15px;
            font-family: 'Cinzel', serif;
            font-size: 1em;
            color: #2c1810;
            resize: vertical;
            margin-bottom: 15px;
        }

        .save-button {
            background: linear-gradient(135deg, #8b4513, #654321);
            color: #f4e4bc;
            border: none;
            padding: 10px 20px;
            font-family: 'MedievalSharp', serif;
            font-size: 1em;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .save-button:hover {
            background: linear-gradient(135deg, #654321, #8b4513);
            transform: translateY(-2px);
        }

        /* Slayer Tab Styles */
        .monster-selector {
            width: 100%;
            background: rgba(244, 228, 188, 0.8);
            border: 2px solid #8b4513;
            border-radius: 5px;
            padding: 10px;
            font-family: 'Cinzel', serif;
            font-size: 1em;
            color: #2c1810;
            margin-bottom: 20px;
        }

        .monster-info {
            background: rgba(139, 69, 19, 0.1);
            border: 1px solid #d4c4a0;
            border-radius: 5px;
            padding: 20px;
            margin-top: 15px;
        }

        .wiki-link {
            color: #8b4513;
            text-decoration: underline;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .wiki-link:hover {
            color: #654321;
            text-decoration: none;
        }

        #monster-name.wiki-link {
            color: #654321;
            font-size: 1.2em;
        }

        #monster-name.wiki-link:hover {
            color: #8b4513;
        }

        /* Magic Progress Bar Styles */
        .magic-progress-bar {
            width: 100%;
            height: 20px;
            background: linear-gradient(45deg, #1a1a2e, #16213e);
            border: 2px solid #4a90e2;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(74, 144, 226, 0.3);
        }

        .magic-progress-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #4a90e2, #74b9ff, #00cec9, #74b9ff, #4a90e2);
            background-size: 200% 100%;
            animation: magicFlow 2s ease-in-out infinite;
            border-radius: 8px;
            transition: width 0.3s ease;
            position: relative;
        }

        .magic-sparkles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(2px 2px at 20px 30px, #fff, transparent),
                radial-gradient(2px 2px at 40px 70px, #74b9ff, transparent),
                radial-gradient(1px 1px at 90px 40px, #00cec9, transparent),
                radial-gradient(1px 1px at 130px 80px, #fff, transparent),
                radial-gradient(2px 2px at 160px 30px, #74b9ff, transparent);
            background-repeat: repeat;
            background-size: 200px 100px;
            animation: sparkle 3s linear infinite;
            opacity: 0.7;
        }

        @keyframes magicFlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes sparkle {
            0% { transform: translateX(-200px); }
            100% { transform: translateX(200px); }
        }

        /* Potions Tab Styles */
        .potions-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(244, 228, 188, 0.8);
            border-radius: 5px;
            overflow: hidden;
            margin-top: 15px;
        }

        .potions-table th,
        .potions-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #8b4513;
            vertical-align: top;
        }

        .potions-table th:nth-child(2),
        .potions-table td:nth-child(2),
        .potions-table th:nth-child(4),
        .potions-table td:nth-child(4) {
            text-align: center;
        }

        .potions-table .wiki-link:hover {
            color: #8b4513 !important;
            text-decoration: underline !important;
        }

        .potions-table th {
            background: linear-gradient(135deg, #8b4513, #654321);
            color: #f4e4bc;
            font-family: 'MedievalSharp', serif;
        }

        .potions-table tr:hover {
            background: rgba(139, 69, 19, 0.2);
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            backdrop-filter: blur(3px);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #f4e4bc, #e8d5a3);
            border: 3px solid #8b4513;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            font-family: 'Cinzel', serif;
        }

        .modal-header {
            background: linear-gradient(135deg, #8b4513, #654321);
            color: #f4e4bc;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-family: 'MedievalSharp', serif;
            font-size: 1.4em;
        }

        .modal-close {
            background: none;
            border: none;
            color: #f4e4bc;
            font-size: 1.8em;
            font-weight: bold;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s ease;
        }

        .modal-close:hover {
            background: rgba(244, 228, 188, 0.2);
        }

        .modal-body {
            padding: 25px;
            color: #2c1810;
        }

        .modal-item-info {
            margin-bottom: 20px;
        }

        .modal-item-info h3 {
            margin: 0 0 10px 0;
            color: #654321;
            font-family: 'MedievalSharp', serif;
            font-size: 1.2em;
        }

        .modal-item-info p {
            margin: 0 0 10px 0;
            line-height: 1.4;
        }

        #modal-item-details {
            background: rgba(139, 69, 19, 0.1);
            border: 1px solid #d4c4a0;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-size: 0.9em;
        }

        .modal-question {
            font-weight: bold;
            text-align: center;
            color: #654321;
            margin: 0;
            font-size: 1.1em;
        }

        .modal-footer {
            padding: 0 25px 25px;
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .modal-button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-family: 'Cinzel', serif;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .modal-cancel {
            background: linear-gradient(135deg, #666, #555);
            color: #f4e4bc;
        }

        .modal-cancel:hover {
            background: linear-gradient(135deg, #555, #444);
            transform: translateY(-2px);
        }

        .modal-confirm {
            background: linear-gradient(135deg, #4a90e2, #357abd);
            color: white;
        }

        .modal-confirm:hover {
            background: linear-gradient(135deg, #357abd, #2968a3);
            transform: translateY(-2px);
        }
        .modal-remove {
            background: linear-gradient(135deg, #dc3545, #c82333) !important;
            color: white !important;
        }
        .modal-remove:hover {
            background: linear-gradient(135deg, #c82333, #bd2130) !important;
            transform: translateY(-2px);
        }

        /* Add to Todo Button Styles */
        .add-to-todo-btn {
            background: linear-gradient(135deg, #4a90e2, #357abd);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8em;
            font-family: 'Cinzel', serif;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 10px;
        }

        .add-to-todo-btn:hover {
            background: linear-gradient(135deg, #357abd, #2968a3);
            transform: translateY(-1px);
        }

        .add-to-todo-btn.added {
            background: linear-gradient(135deg, #28a745, #218838);
            pointer-events: none;
        }

        .add-to-todo-btn.added:after {
            content: " âœ“";
        }

        .add-to-todo-btn-small {
            padding: 2px 6px;
            font-size: 0.7em;
            margin-left: 5px;
            min-width: auto;
            border-radius: 3px;
        }

        /* Skill Level Input Styles */
        #skill-level-input {
            background: rgba(139, 69, 19, 0.1);
            border: 1px solid #d4c4a0;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }

        .skill-level-label {
            display: block;
            font-weight: bold;
            color: #654321;
            margin-bottom: 8px;
            font-family: 'MedievalSharp', serif;
        }

        .level-input-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .level-input {
            width: 80px;
            padding: 8px 12px;
            border: 2px solid #8b4513;
            border-radius: 5px;
            background: #f4e4bc;
            color: #2c1810;
            font-family: 'Cinzel', serif;
            font-size: 1em;
            font-weight: bold;
            text-align: center;
        }

        .level-input:focus {
            outline: none;
            border-color: #654321;
            box-shadow: 0 0 5px rgba(139, 69, 19, 0.3);
        }

        .level-info {
            color: #654321;
            font-weight: bold;
            font-size: 0.9em;
        }

        #current-level {
            color: #8b4513;
            font-weight: bold;
        }

        /* To-Do List Tab Styles */
        #master-list-container {
            height: 35%;
            background: rgba(244, 228, 188, 0.3);
            border: 2px inset #8b4513;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            overflow-y: auto;
            position: relative;
        }
        
        #master-goals-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .goal-category {
            background: rgba(139, 69, 19, 0.1);
            border: 1px solid #d4c4a0;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
        }
        
        .goal-category h4 {
            margin: 0 0 8px 0;
            color: #654321;
            font-family: 'MedievalSharp', serif;
            font-size: 1.1em;
            border-bottom: 1px solid #d4c4a0;
            padding-bottom: 5px;
        }
        
        .goal-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
            padding: 3px;
            border-radius: 3px;
            transition: background 0.2s ease;
        }
        
        .goal-item:hover {
            background: rgba(139, 69, 19, 0.1);
        }
        
        .goal-checkbox {
            margin-right: 8px;
            cursor: pointer;
            transform: scale(1.2);
        }
        
        .goal-label {
            cursor: pointer;
            font-size: 0.9em;
            color: #2c1810;
            flex: 1;
            user-select: none;
        }
        
        #requirements-container {
            height: 55%;
            background: rgba(244, 228, 188, 0.3);
            border: 2px inset #8b4513;
            border-radius: 8px;
            padding: 15px;
        }
        
        #requirements-container h2 {
            margin: 0 0 15px 0;
            color: #654321;
            font-family: 'MedievalSharp', serif;
            font-size: 1.2em;
            text-align: center;
            border-bottom: 2px solid #d4c4a0;
            padding-bottom: 8px;
        }
        
        .requirements-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(8, 1fr);
            grid-auto-flow: column;
            gap: 6px;
            height: calc(100% - 50px);
            max-height: 400px;
        }
        
        .requirement-item {
            display: flex;
            align-items: center;
            background: rgba(139, 69, 19, 0.1);
            border: 1px solid #d4c4a0;
            border-radius: 4px;
            padding: 4px 6px;
            position: relative;
            min-height: 32px;
            font-size: 0.85em;
        }
        
        .requirement-item.required {
            background: rgba(220, 53, 69, 0.2);
            border-color: #dc3545;
        }
        
        .requirement-item .stat-icon {
            width: 20px;
            height: 20px;
            margin-right: 6px;
            opacity: 0.7;
            flex-shrink: 0;
        }
        
        .requirement-item.required .stat-icon {
            opacity: 1;
        }
        
        .requirement-level {
            font-size: 0.85em;
            color: #654321;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .requirement-item.required .requirement-level {
            color: #dc3545;
            font-weight: bold;
        }
        

        /* Remove Button Styles */
        .remove-goal-btn {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7em;
            font-family: 'Cinzel', serif;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 5px;
            opacity: 0.7;
        }

        .remove-goal-btn:hover {
            background: linear-gradient(135deg, #c82333, #bd2130);
            transform: translateY(-1px);
            opacity: 1;
        }

        .goal-item:hover .remove-goal-btn {
            opacity: 1;
        }

        /* Right Page Specific Styles */
        .right-page .tab-content-area {
            border-radius: 0 10px 10px 0;
        }
        
        /* Right Side Tab Navigation */
        .tab-navigation-right {
            background: linear-gradient(135deg, #8b4513, #654321);
            width: 60px;
            display: flex;
            flex-direction: column;
            border-radius: 0 10px 10px 0;
            position: relative;
            z-index: 2;
        }

        .tab-button-right {
            background: rgba(139, 69, 19, 0.8);
            border: none;
            color: #f4e4bc;
            font-family: 'MedievalSharp', serif;
            font-size: 0.8em;
            padding: 15px 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 1px solid rgba(101, 67, 33, 0.5);
            writing-mode: vertical-lr;
            text-orientation: mixed;
            min-height: 80px;
        }

        .tab-button-right:hover {
            background: rgba(139, 69, 19, 1);
            transform: translateX(-3px);
        }

        .tab-button-right.active {
            background: linear-gradient(135deg, #f4e4bc, #e8d7b0);
            color: #2c1810;
            transform: translateX(-5px);
            box-shadow: -2px 0 10px rgba(0,0,0,0.3);
        }

        .tab-button-right:first-child {
            border-radius: 0 10px 0 0;
        }

        .tab-button-right:last-child {
            border-bottom: none;
            border-radius: 0 0 10px 0;
        }

        /* Character Lookup */
        .character-lookup {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }

        /* Username lookup styles */
        .lookup-section {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
        }
        
        #username-input {
            flex: 1;
            max-width: 250px;
            padding: 10px 15px;
            border: 2px solid #8b4513;
            border-radius: 8px;
            background: rgba(244, 228, 188, 0.9);
            font-family: 'Cinzel', serif;
            font-size: 1em;
            color: #2c1810;
            outline: none;
            transition: all 0.3s ease;
        }
        
        #username-input:focus {
            border-color: #654321;
            background: rgba(244, 228, 188, 1);
            box-shadow: 0 0 10px rgba(139, 69, 19, 0.3);
        }
        
        #lookup-btn {
            background: linear-gradient(135deg, #8b4513, #654321);
            color: #f4e4bc;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-family: 'MedievalSharp', serif;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        #lookup-btn:hover {
            background: linear-gradient(135deg, #654321, #8b4513);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }


        /* Achievement Diaries Styles */
        .diaries-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .diary-tile {
            background: linear-gradient(135deg, #f4e4bc, #e8d7b0);
            border: 2px solid #8b4513;
            border-radius: 8px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            text-align: center;
        }

        .diary-tile:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            background: linear-gradient(135deg, #f8e8cc, #ecd8bc);
        }

        .diary-tile h3 {
            font-family: 'MedievalSharp', serif;
            font-size: 1.2em;
            color: #654321;
            margin-bottom: 8px;
        }

        .diary-tile p {
            font-size: 0.9em;
            color: #8b4513;
            margin: 0;
        }

        /* Page Corner Flip Effect */
        .tile-corner {
            position: absolute;
            top: 0;
            right: 0;
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-top: 20px solid #d4c4a0;
            transition: all 0.3s ease;
        }

        .diary-tile:hover .tile-corner {
            border-left: 25px solid transparent;
            border-top: 25px solid #c8b894;
        }

        .tile-corner::after {
            content: '';
            position: absolute;
            top: -18px;
            right: -18px;
            width: 16px;
            height: 16px;
            background: linear-gradient(225deg, #b8a888, #a69777);
            border-radius: 0 0 0 2px;
        }

        /* Diary Detail View */
        .diary-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .back-button {
            background: linear-gradient(135deg, #8b4513, #654321);
            color: #f4e4bc;
            border: none;
            padding: 8px 15px;
            font-family: 'MedievalSharp', serif;
            font-size: 0.9em;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 20px;
        }

        .back-button:hover {
            background: linear-gradient(135deg, #654321, #8b4513);
            transform: translateY(-2px);
        }

        .diary-requirements {
            background: rgba(139, 69, 19, 0.1);
            border: 1px solid #d4c4a0;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .diary-requirements h3 {
            font-family: 'MedievalSharp', serif;
            color: #654321;
            margin-bottom: 10px;
        }

        .requirements-list {
            list-style: none;
            padding: 0;
        }

        .requirements-list li {
            padding: 5px 0;
            border-bottom: 1px solid rgba(139, 69, 19, 0.2);
        }

        .requirements-list li:last-child {
            border-bottom: none;
        }

        .reward-item {
            color: #8b4513;
            font-weight: bold;
        }

        /* Difficulty Tiles */
        .difficulty-tiles {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .difficulty-tile {
            border: 2px solid #8b4513;
            border-radius: 8px;
            padding: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            min-height: 140px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            text-align: center;
        }

        .difficulty-tile:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }

        .difficulty-tile.easy {
            background: linear-gradient(135deg, #d4f4d4, #c8e8c8);
            border-color: #5a9b5a;
        }

        .difficulty-tile.easy:hover {
            background: linear-gradient(135deg, #e0f8e0, #d4ecd4);
        }

        .difficulty-tile.medium {
            background: linear-gradient(135deg, #fff4d4, #f4e8c8);
            border-color: #cc9900;
        }

        .difficulty-tile.medium:hover {
            background: linear-gradient(135deg, #fff8e0, #f8ecd4);
        }

        .difficulty-tile.hard {
            background: linear-gradient(135deg, #f4d4d4, #e8c8c8);
            border-color: #cc3333;
        }

        .difficulty-tile.hard:hover {
            background: linear-gradient(135deg, #f8e0e0, #ecd4d4);
        }

        .difficulty-tile.elite {
            background: linear-gradient(135deg, #e4d4f4, #d8c8e8);
            border-color: #8855cc;
        }

        .difficulty-tile.elite:hover {
            background: linear-gradient(135deg, #e8e0f8, #dcd4ec);
        }

        .difficulty-tile h3 {
            font-family: 'MedievalSharp', serif;
            font-size: 1.4em;
            margin-bottom: 8px;
        }

        .difficulty-tile.easy h3 { color: #2d5a2d; }
        .difficulty-tile.medium h3 { color: #b8860b; }
        .difficulty-tile.hard h3 { color: #8b0000; }
        .difficulty-tile.elite h3 { color: #663399; }

        .difficulty-tile p {
            font-size: 1em;
            margin: 0;
            opacity: 0.8;
        }

        /* Difficulty Detail View */
        .difficulty-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .difficulty-requirements {
            background: rgba(139, 69, 19, 0.1);
            border: 1px solid #d4c4a0;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .difficulty-requirements h3 {
            font-family: 'MedievalSharp', serif;
            color: #654321;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .task-list {
            list-style: none;
            padding: 0;
            margin-bottom: 20px;
        }

        .task-list li {
            padding: 8px 0;
            border-bottom: 1px solid rgba(139, 69, 19, 0.2);
            position: relative;
            padding-left: 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .task-list li label {
            flex: 1;
            margin-left: 8px;
        }

        .task-list li:last-child {
            border-bottom: none;
        }

        .task-list li::before {
            content: 'â€¢';
            position: absolute;
            left: 0;
            color: #8b4513;
            font-weight: bold;
            font-size: 1.2em;
        }

        .rewards-section {
            background: rgba(139, 69, 19, 0.05);
            border: 1px solid #e8d7b0;
            border-radius: 5px;
            padding: 15px;
            margin-top: 20px;
        }

        .rewards-section h4 {
            font-family: 'MedievalSharp', serif;
            color: #654321;
            margin-bottom: 10px;
        }

        /* Quest Styles */
        .quest-filter {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }

        .quest-search {
            flex: 1;
            background: rgba(244, 228, 188, 0.8);
            border: 2px solid #8b4513;
            border-radius: 5px;
            padding: 10px;
            font-family: 'Cinzel', serif;
            font-size: 1em;
            color: #2c1810;
        }

        #quest-difficulty-filter {
            background: rgba(244, 228, 188, 0.8);
            border: 2px solid #8b4513;
            border-radius: 5px;
            padding: 10px;
            font-family: 'Cinzel', serif;
            font-size: 1em;
            color: #2c1810;
            min-width: 150px;
        }

        .quest-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            max-height: 500px;
            overflow-y: auto;
        }

        .quest-item {
            background: linear-gradient(135deg, #f4e4bc, #e8d7b0);
            border: 1px solid #8b4513;
            border-radius: 5px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .quest-item:hover {
            background: linear-gradient(135deg, #f8e8cc, #ecd8bc);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .quest-actions {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }

        .quest-info h3 {
            font-family: 'MedievalSharp', serif;
            color: #654321;
            margin: 0 0 5px 0;
            font-size: 1.1em;
        }

        .quest-info p {
            color: #8b4513;
            margin: 0;
            font-size: 0.9em;
        }

        .difficulty-badge {
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 0.8em;
            font-weight: bold;
            font-family: 'MedievalSharp', serif;
        }



        .difficulty-badge.novice { background: #90EE90; color: #2d5a2d; }
        .difficulty-badge.intermediate { background: #FFD700; color: #8b7500; }
        .difficulty-badge.experienced { background: #FFA500; color: #8b5a00; }
        .difficulty-badge.master { background: #FF6347; color: #8b0000; }
        .difficulty-badge.grandmaster { background: #8A2BE2; color: #ffffff; }

        /* Quest Detail View */
        .quest-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            gap: 15px;
        }

        .quest-section {
            background: rgba(139, 69, 19, 0.1);
            border: 1px solid #d4c4a0;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .quest-section h3 {
            font-family: 'MedievalSharp', serif;
            color: #654321;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .quest-section h4 {
            font-family: 'MedievalSharp', serif;
            color: #8b4513;
            margin: 15px 0 8px 0;
            font-size: 1em;
        }

        .item-list {
            list-style: none;
            padding: 0;
            margin: 10px 0;
        }

        .item-list li {
            padding: 3px 0;
            color: #654321;
        }

        .required-item {
            font-weight: bold;
            color: #8b0000;
        }

        .optional-item {
            font-style: italic;
            color: #8b4513;
        }

        .guide-step {
            background: rgba(244, 228, 188, 0.5);
            border-left: 3px solid #8b4513;
            padding: 10px 15px;
            margin: 8px 0;
            border-radius: 0 5px 5px 0;
        }

        .reward-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .reward-item {
            background: rgba(139, 69, 19, 0.2);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9em;
            color: #654321;
            border: 1px solid #d4c4a0;
        }

        /* Stats Panel */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(8, 1fr);
            grid-auto-flow: column;
            gap: 8px;
            margin-bottom: 20px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            background: rgba(139, 69, 19, 0.1);
            border: 1px solid #d4c4a0;
            border-radius: 5px;
            padding: 5px;
        }

        .stat-icon {
            width: 20px;
            height: 20px;
            margin-right: 8px;
        }

        .stat-level {
            font-size: 0.9em;
            font-weight: 600;
            color: #654321;
        }

        /* Gear Panel */
        .gear-grid {
            display: grid;
            grid-template-areas:
                ". head ."
                "cape amulet weapon"
                ". body shield"
                ". legs ."
                "hands . feet"
                "ring . ammo";
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            max-width: 200px;
            margin: 0 auto 20px auto;
        }

        .gear-slot {
            width: 50px;
            height: 50px;
            border: 2px solid #8b4513;
            background: rgba(139, 69, 19, 0.1);
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
            color: #654321;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .gear-slot:hover {
            background: rgba(139, 69, 19, 0.2);
        }

        .gear-slot.head { grid-area: head; }
        .gear-slot.cape { grid-area: cape; }
        .gear-slot.amulet { grid-area: amulet; }
        .gear-slot.weapon { grid-area: weapon; }
        .gear-slot.body { grid-area: body; }
        .gear-slot.shield { grid-area: shield; }
        .gear-slot.legs { grid-area: legs; }
        .gear-slot.hands { grid-area: hands; }
        .gear-slot.feet { grid-area: feet; }
        .gear-slot.ring { grid-area: ring; }
        .gear-slot.ammo { grid-area: ammo; }

        /* Equipment Selector */
        .equipment-search {
            width: 100%;
            background: rgba(244, 228, 188, 0.8);
            border: 2px solid #8b4513;
            border-radius: 5px;
            padding: 10px;
            font-family: 'Cinzel', serif;
            font-size: 1em;
            color: #2c1810;
            margin-bottom: 10px;
        }

        .search-results {
            background: rgba(244, 228, 188, 0.9);
            border: 1px solid #8b4513;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .search-result-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid rgba(139, 69, 19, 0.2);
            transition: background-color 0.3s;
        }

        .search-result-item:hover {
            background: rgba(139, 69, 19, 0.2);
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .book-pages {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .book-pages::before {
                display: none;
            }
            
            .journal-container {
                padding: 20px;
            }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .tab-navigation {
                width: 50px;
            }
            
            .tab-button {
                font-size: 0.7em;
                padding: 10px 3px;
                min-height: 60px;
            }
        }
    </style>
    <!-- Include monster database -->
    <script src="monsters.js"></script>
    <!-- Include potions database -->
    <script src="potions.js"></script>
    <!-- Include diaries database -->
    <script src="diaries.js"></script>
    <!-- Include locations database -->
    <script src="locations.js"></script>
    <!-- Include quests database -->
    <script src="quests.js"></script>
</head>
<body>
    <div class="journal-container">
        <div class="book-pages">
            <!-- Left Page - Interactive Journal -->
            <div class="page left-page">
                <div class="tab-navigation">
                    <button class="tab-button active" onclick="switchTab('left', 'notes', this)">Notes</button>
                    <button class="tab-button" onclick="switchTab('left', 'slayer', this)">Slayer</button>
                    <button class="tab-button" onclick="switchTab('left', 'potions', this)">Potions</button>
                    <button class="tab-button" onclick="switchTab('left', 'todo', this)">To-Do List</button>
                </div>
                <div class="tab-content-area">
                    <!-- Notes Tab -->
                    <div id="notes-tab" class="tab-content active">
                        <h1>Personal Notes</h1>
                        <textarea id="personal-notes" class="notes-textarea" placeholder="Write your OSRS notes here... (automatically saved)"></textarea>
                        <button class="save-button" onclick="saveNotes()">Save Notes</button>
                        <p id="save-status" style="margin-top: 10px; color: #8b4513; font-style: italic;"></p>
                    </div>

                    <!-- Slayer Tab -->
                    <div id="slayer-tab" class="tab-content">
                        <h1>Slayer Guide</h1>
                        <h2>Choose a Slayer Monster:</h2>
                        <div style="margin-bottom: 15px;">
                            <button onclick="populateMonsterSelector()" style="margin-right: 10px; padding: 5px 10px; background: #8b4513; color: white; border: none; border-radius: 3px; cursor: pointer;">ðŸ”„ Reload Monsters</button>
                            <button onclick="downloadFullMonsterList()" style="padding: 5px 10px; background: #4a90e2; color: white; border: none; border-radius: 3px; cursor: pointer;">ðŸ“¥ Download Complete Slayer Database</button>
                        </div>
                        <div id="download-progress-container" style="display: none; margin-bottom: 15px;">
                            <div style="margin-bottom: 5px; color: #2c1810; font-size: 0.9em;">Updating monster database...</div>
                            <div class="magic-progress-bar">
                                <div id="magic-progress-fill" class="magic-progress-fill"></div>
                                <div class="magic-sparkles"></div>
                            </div>
                        </div>
                        <select id="monster-selector" class="monster-selector" onchange="updateMonsterInfo()">
                            <option value="">Select a monster...</option>
                        </select>
                        <div id="monster-info" class="monster-info" style="display: none;">
                            <h3 id="monster-name"></h3>
                            <p id="monster-description"></p>
                            <h4>Hitpoints:</h4>
                            <p id="monster-hp"></p>
                            <h4>Defenses:</h4>
                            <p id="monster-defenses"></p>
                            <h4>Weaknesses:</h4>
                            <p id="monster-weaknesses"></p>
                            <h4>Notable Drops:</h4>
                            <p id="monster-drops"></p>
                            <h4>Location:</h4>
                            <p id="monster-location"></p>
                        </div>
                    </div>

                    <!-- Potions Tab -->
                    <div id="potions-tab" class="tab-content">
                        <h1>Herblore Guide</h1>
                        <div style="margin-bottom: 15px;">
                            <label for="potion-category-filter" style="margin-right: 10px; color: #2c1810; font-weight: bold;">Filter by Category:</label>
                            <select id="potion-category-filter" onchange="filterPotions()" style="padding: 5px; border: 1px solid #8b4513; border-radius: 3px; background: #f4e4bc;">
                                <option value="all">All Potions</option>
                                <option value="Combat">Combat Potions</option>
                                <option value="Prayer">Prayer & Restore</option>
                                <option value="Skill">Skill Potions</option>
                                <option value="Barbarian">Barbarian Herblore</option>
                            </select>
                            <label for="potion-level-filter" style="margin: 0 10px; color: #2c1810; font-weight: bold;">Min Level:</label>
                            <input type="number" id="potion-level-filter" min="1" max="99" value="1" onchange="filterPotions()" style="width: 60px; padding: 5px; border: 1px solid #8b4513; border-radius: 3px;">
                        </div>
                        <table class="potions-table">
                            <thead>
                                <tr>
                                    <th>Potion Name</th>
                                    <th>Level Required</th>
                                    <th>Ingredients</th>
                                    <th>XP Gained</th>
                                    <th>Effect</th>
                                </tr>
                            </thead>
                            <tbody id="potions-table-body">
                                <!-- Potions will be populated dynamically -->
                            </tbody>
                        </table>
                    </div>

                    <!-- To-Do List Tab -->
                    <div id="todo-tab" class="tab-content">
                        <h1>Personal To-Do List</h1>
                        
                        <!-- Master List Container - Top Half -->
                        <div id="master-list-container">
                            <h2>Select Goals</h2>
                            <div id="master-goals-list">
                                <!-- Goals checkboxes will be populated dynamically -->
                                <p style="text-align: center; color: #666; margin-top: 50px;">Loading goals...</p>
                            </div>
                        </div>
                        
                        <!-- Requirements Container - Bottom Half -->
                        <div id="requirements-container">
                            <h2>Skill Requirements</h2>
                            
                            <!-- Skill Requirements Grid -->
                            <div id="skill-requirements">
                                <div class="requirements-grid">
                                    <!-- Skills will be populated dynamically to match stats tab layout -->
                                    <p style="text-align: center; color: #666; margin-top: 50px;">Select goals above to see skill requirements</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Page - Player Dashboard -->
            <div class="page right-page">
                <div class="tab-content-area">
                    <!-- Stats Tab -->
                    <div id="stats-tab" class="tab-content active">
                        <h1>Player Stats</h1>
                        
                        <!-- Character Lookup Section -->
                        <div class="lookup-section">
                            <input type="text" id="username-input" placeholder="Enter OSRS username" />
                            <button id="lookup-btn" onclick="lookupPlayer()">Lookup Player</button>
                        </div>
                        
                        <div class="stats-grid">
                            <!-- Column 1: Attack, Strength, Defence, Ranged, Prayer, Magic, Runecrafting, Construction -->
                            <div class="stat-item">
                                <img src="https://oldschool.runescape.wiki/images/Attack_icon.png" alt="Attack" class="stat-icon">
                                <span class="stat-level">99/99</span>
                            </div>
                            <div class="stat-item">
                                <img src="https://oldschool.runescape.wiki/images/Strength_icon.png" alt="Strength" class="stat-icon">
                                <span class="stat-level">99/99</span>
                            </div>
                            <div class="stat-item">
                                <img src="https://oldschool.runescape.wiki/images/Defence_icon.png" alt="Defence" class="stat-icon">
                                <span class="stat-level">99/99</span>
                            </div>
                            <div class="stat-item">
                                <img src="https://oldschool.runescape.wiki/images/Ranged_icon.png" alt="Ranged" class="stat-icon">
                                <span class="stat-level">99/99</span>
                            </div>
                            <div class="stat-item">
                                <img src="https://oldschool.runescape.wiki/images/Prayer_icon.png" alt="Prayer" class="stat-icon">
                                <span class="stat-level">99/99</span>
                            </div>
                            <div class="stat-item">
                                <img src="https://oldschool.runescape.wiki/images/Magic_icon.png" alt="Magic" class="stat-icon">
                                <span class="stat-level">99/99</span>
                            </div>
                            <div class="stat-item">
                                <img src="https://oldschool.runescape.wiki/images/Runecraft_icon.png" alt="Runecraft" class="stat-icon">
                                <span class="stat-level">77/99</span>
                            </div>
                            <div class="stat-item">
                                <img src="https://oldschool.runescape.wiki/images/Construction_icon.png" alt="Construction" class="stat-icon">
                                <span class="stat-level">85/99</span>
                            </div>

                            <!-- Column 2: Hitpoints, Agility, Herblore, Thieving, Crafting, Fletching, Slayer, Hunter -->
                            <div class="stat-item">
                                <img src="https://oldschool.runescape.wiki/images/Hitpoints_icon.png" alt="Hitpoints" class="stat-icon">
                                <span class="stat-level">99/99</span>
                            </div>
                            <div class="stat-item">
                                <img src="https://oldschool.runescape.wiki/images/Agility_icon.png" alt="Agility" class="stat-icon">
                                <span class="stat-level">90/99</span>
                            </div>
                            <div class="stat-item">
                                <img src="https://oldschool.runescape.wiki/images/Herblore_icon.png" alt="Herblore" class="stat-icon">
                                <span class="stat-level">88/99</span>
                            </div>
                            <div class="stat-item">
                                <img src="https://oldschool.runescape.wiki/images/Thieving_icon.png" alt="Thieving" class="stat-icon">
                                <span class="stat-level">92/99</span>
                            </div>
                            <div class="stat-item">
                                <img src="https://oldschool.runescape.wiki/images/Crafting_icon.png" alt="Crafting" class="stat-icon">
                                <span class="stat-level">85/99</span>
                            </div>
                            <div class="stat-item">
                                <img src="https://oldschool.runescape.wiki/images/Fletching_icon.png" alt="Fletching" class="stat-icon">
                                <span class="stat-level">95/99</span>
                            </div>
                            <div class="stat-item">
                                <img src="https://oldschool.runescape.wiki/images/Slayer_icon.png" alt="Slayer" class="stat-icon">
                                <span class="stat-level">85/99</span>
                            </div>
                            <div class="stat-item">
                                <img src="https://oldschool.runescape.wiki/images/Hunter_icon.png" alt="Hunter" class="stat-icon">
                                <span class="stat-level">80/99</span>
                            </div>

                            <!-- Column 3: Mining, Smithing, Fishing, Cooking, Firemaking, Woodcutting, Farming -->
                            <div class="stat-item">
                                <img src="https://oldschool.runescape.wiki/images/Mining_icon.png" alt="Mining" class="stat-icon">
                                <span class="stat-level">88/99</span>
                            </div>
                            <div class="stat-item">
                                <img src="https://oldschool.runescape.wiki/images/Smithing_icon.png" alt="Smithing" class="stat-icon">
                                <span class="stat-level">83/99</span>
                            </div>
                            <div class="stat-item">
                                <img src="https://oldschool.runescape.wiki/images/Fishing_icon.png" alt="Fishing" class="stat-icon">
                                <span class="stat-level">92/99</span>
                            </div>
                            <div class="stat-item">
                                <img src="https://oldschool.runescape.wiki/images/Cooking_icon.png" alt="Cooking" class="stat-icon">
                                <span class="stat-level">99/99</span>
                            </div>
                            <div class="stat-item">
                                <img src="https://oldschool.runescape.wiki/images/Firemaking_icon.png" alt="Firemaking" class="stat-icon">
                                <span class="stat-level">87/99</span>
                            </div>
                            <div class="stat-item">
                                <img src="https://oldschool.runescape.wiki/images/Woodcutting_icon.png" alt="Woodcutting" class="stat-icon">
                                <span class="stat-level">90/99</span>
                            </div>
                            <div class="stat-item">
                                <img src="https://oldschool.runescape.wiki/images/Farming_icon.png" alt="Farming" class="stat-icon">
                                <span class="stat-level">85/99</span>
                            </div>
                        </div>
                    </div>

                    <!-- Achievement Diaries Tab -->
                    <div id="diaries-tab" class="tab-content">
                        <div id="diary-main-view">
                            <h1>Achievement Diaries</h1>
                            <div style="margin-bottom: 15px;">
                                <button onclick="populateDiaryTiles()" style="margin-right: 10px; padding: 5px 10px; background: #8b4513; color: white; border: none; border-radius: 3px; cursor: pointer;">ðŸ”„ Reload Diaries</button>
                                <span id="diary-progress-summary" style="color: #2c1810; font-weight: bold;"></span>
                            </div>
                            <div class="diaries-grid" id="diaries-grid">
                                <!-- Diary tiles will be populated dynamically -->
                            </div>
                        </div>
                        
                        <div id="diary-detail-view" style="display: none;">
                            <div class="diary-header">
                                <button class="back-button" onclick="closeDiary()">â† Back to Diaries</button>
                                <h1 id="diary-title"></h1>
                            </div>
                            <div class="difficulty-tiles">
                                <div class="difficulty-tile easy" onclick="showDifficulty('easy')">
                                    <div class="tile-corner"></div>
                                    <h3>Easy</h3>
                                    <p>Beginner tasks</p>
                                </div>
                                <div class="difficulty-tile medium" onclick="showDifficulty('medium')">
                                    <div class="tile-corner"></div>
                                    <h3>Medium</h3>
                                    <p>Intermediate tasks</p>
                                </div>
                                <div class="difficulty-tile hard" onclick="showDifficulty('hard')">
                                    <div class="tile-corner"></div>
                                    <h3>Hard</h3>
                                    <p>Advanced tasks</p>
                                </div>
                                <div class="difficulty-tile elite" onclick="showDifficulty('elite')">
                                    <div class="tile-corner"></div>
                                    <h3>Elite</h3>
                                    <p>Master tasks</p>
                                </div>
                            </div>
                        </div>

                        <div id="difficulty-detail-view" style="display: none;">
                            <div class="difficulty-header">
                                <button class="back-button" onclick="backToDiary()">â† Back to Diary</button>
                                <h1 id="difficulty-title"></h1>
                            </div>
                            <div id="difficulty-content"></div>
                        </div>
                    </div>

                    <!-- Quests Tab -->
                    <div id="quests-tab" class="tab-content">
                        <div id="quest-main-view">
                            <h1>Quest Journal</h1>
                            
                            <!-- Quest Filter -->
                            <div class="quest-filter">
                                <select id="quest-difficulty-filter" onchange="filterQuests()">
                                    <option value="all">All Difficulties</option>
                                    <option value="novice">Novice</option>
                                    <option value="intermediate">Intermediate</option>
                                    <option value="experienced">Experienced</option>
                                    <option value="master">Master</option>
                                    <option value="grandmaster">Grandmaster</option>
                                </select>
                                <input type="text" id="quest-search" class="quest-search" placeholder="Search quests..." oninput="filterQuests()">
                            </div>

                            <!-- Quest List -->
                            <div id="quest-list" class="quest-list"></div>
                        </div>
                        
                        <div id="quest-detail-view" style="display: none;">
                            <div class="quest-header">
                                <button class="back-button" onclick="closeQuest()">â† Back to Quests</button>
                                <h1 id="quest-title"></h1>
                                <span id="quest-difficulty-badge" class="difficulty-badge"></span>
                            </div>
                            <div id="quest-content"></div>
                        </div>
                    </div>
                </div>
                <div class="tab-navigation-right">
                    <button class="tab-button-right active" onclick="switchTab('right', 'stats', this)">Stats</button>
                    <button class="tab-button-right" onclick="switchTab('right', 'diaries', this)">Diaries</button>
                    <button class="tab-button-right" onclick="switchTab('right', 'quests', this)">Quests</button>
                </div>
            </div>
        </div>
    </div>

    <!-- External Quest Database -->
    <!-- Quest database now loaded above in quests.js -->
    
    <script>
        // Tab switching functionality
        function switchTab(page, tabName, buttonElement) {
            // Hide all tab contents for the specified page
            const tabContents = document.querySelectorAll(`#${tabName}-tab`);
            document.querySelectorAll(`.${page}-page .tab-content`).forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tab buttons for the specified page
            if (page === 'left') {
                document.querySelectorAll(`.${page}-page .tab-button`).forEach(button => {
                    button.classList.remove('active');
                });
            } else {
                document.querySelectorAll(`.${page}-page .tab-button-right`).forEach(button => {
                    button.classList.remove('active');
                });
            }
            
            // Show the selected tab content
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Add active class to the clicked button
            buttonElement.classList.add('active');
        }

        // Notes functionality with localStorage
        function saveNotes() {
            const notes = document.getElementById('personal-notes').value;
            localStorage.setItem('osrs-player-notes', notes);
            
            const statusElement = document.getElementById('save-status');
            statusElement.textContent = 'Notes saved successfully!';
            statusElement.style.color = '#8b4513';
            
            setTimeout(() => {
                statusElement.textContent = '';
            }, 3000);
        }

        function loadNotes() {
            const savedNotes = localStorage.getItem('osrs-player-notes');
            if (savedNotes) {
                document.getElementById('personal-notes').value = savedNotes;
            }
        }

        // Auto-save notes on input and load saved data
        document.addEventListener('DOMContentLoaded', async function() {
            loadNotes();
            // User lookup removed
            
            // Initialize monster dropdown with static data
            populateMonsterSelector();
            
            // Initialize potions table
            populatePotionsTable();
            
            const notesTextarea = document.getElementById('personal-notes');
            notesTextarea.addEventListener('input', function() {
                // Auto-save after 2 seconds of no typing
                clearTimeout(this.saveTimeout);
                this.saveTimeout = setTimeout(() => {
                    saveNotes();
                }, 2000);
            });

            // User lookup functionality removed - hiscores polling only
        });



        /**
         * Formats defense stats from API data
         */
        function formatDefenses(monster) {
            const def = monster.defence_level || 0;
            const magicDef = monster.magic_defence_level || def;
            const rangeDef = monster.ranged_defence_level || def;
            return `Melee Defence: ${def}, Magic Defence: ${magicDef}, Ranged Defence: ${rangeDef}`;
        }

        /**
         * Formats weaknesses from API data
         */
        function formatWeaknesses(monster) {
            // The API has attack_styles which we can use to infer weaknesses
            const weaknesses = [];
            
            if (monster.attack_type) {
                if (monster.attack_type.includes('magic') || monster.magic_defence_level < monster.defence_level) {
                    weaknesses.push('Magic attacks');
                }
                if (monster.attack_type.includes('ranged') || monster.ranged_defence_level < monster.defence_level) {
                    weaknesses.push('Ranged attacks');
                }
                if (monster.attack_type.includes('melee')) {
                    weaknesses.push('Specific melee styles');
                }
            }
            
            // Add special weaknesses based on monster attributes
            if (monster.attributes && monster.attributes.includes('undead')) {
                weaknesses.push('Salve amulet');
            }
            if (monster.attributes && monster.attributes.includes('demon')) {
                weaknesses.push('Arclight', 'Silverlight');
            }
            if (monster.attributes && monster.attributes.includes('dragon')) {
                weaknesses.push('Anti-dragon shield', 'Dragonbane weapons');
            }
            
            return weaknesses.length > 0 ? weaknesses.join(', ') : 'No specific weaknesses';
        }

        /**
         * Formats notable drops from API data
         */
        function formatDrops(monster) {
            if (monster.drops && Array.isArray(monster.drops)) {
                // Get the most valuable/notable drops
                const notableDrops = monster.drops
                    .filter(drop => drop.rarity && (drop.rarity === 'rare' || drop.rarity === 'very_rare'))
                    .slice(0, 5) // Limit to top 5 drops
                    .map(drop => drop.name || drop.id);
                
                if (notableDrops.length > 0) {
                    return notableDrops.join(', ');
                }
            }
            
            return 'Various drops available';
        }

        // Monster data now comes from monsters.js

        function updateMonsterInfo() {
            const selector = document.getElementById('monster-selector');
            const infoDiv = document.getElementById('monster-info');
            const selectedMonster = selector.value;
            
            if (!selectedMonster) {
                infoDiv.style.display = 'none';
                return;
            }
            
            // Get monster from database
            const monster = getMonsterById(selectedMonster);
            
            if (monster) {
                // Set monster name as clickable wiki link
                const nameElement = document.getElementById('monster-name');
                nameElement.innerHTML = `<span class="wiki-link" onclick="openWikiLink('${monster.name}')">${monster.name}</span>`;
                
                // Format and display monster information
                const description = `Level ${monster.slayer_level} Slayer. ${monster.examine}`;
                document.getElementById('monster-description').textContent = description;
                document.getElementById('monster-hp').textContent = monster.hitpoints;
                document.getElementById('monster-defenses').textContent = formatMonsterDefenses(monster);
                document.getElementById('monster-weaknesses').textContent = monster.weaknesses || 'None specified';
                
                // Format and make drops clickable
                document.getElementById('monster-drops').innerHTML = makeLinksClickable(formatMonsterDrops(monster));
                
                // Format and make locations clickable using locations database
                const locationDetails = formatMonsterLocations(monster);
                document.getElementById('monster-location').innerHTML = locationDetails;
                
                infoDiv.style.display = 'block';
            } else {
                console.log('Monster not found:', selectedMonster);
                infoDiv.style.display = 'none';
            }
        }

        // Function to populate monster selector dropdown
        function populateMonsterSelector() {
            const selector = document.getElementById('monster-selector');
            console.log('Populating monster selector from database...');
            
            // Check if monsters.js functions are available
            if (typeof getSlayerMonsters === 'undefined') {
                console.error('getSlayerMonsters function not found! monsters.js may not be loaded.');
                return;
            }
            
            if (typeof MONSTER_DATABASE === 'undefined') {
                console.error('MONSTER_DATABASE not found! monsters.js may not be loaded.');
                return;
            }
            
            console.log('Monster database available:', Object.keys(MONSTER_DATABASE).length, 'monsters');
            
            // Get slayer monsters from the database
            const slayerMonsters = getSlayerMonsters();
            console.log(`Found ${slayerMonsters.length} slayer monsters in database`);
            
            // Clear existing options
            selector.innerHTML = '<option value="">Select a monster...</option>';
            
            // Add monster options sorted by slayer level
            slayerMonsters.forEach(monster => {
                const option = document.createElement('option');
                option.value = Object.keys(MONSTER_DATABASE).find(key => 
                    MONSTER_DATABASE[key].name === monster.name
                );
                option.textContent = `${monster.name} (Level ${monster.slayer_level} Slayer)`;
                selector.appendChild(option);
            });
            
            console.log(`Loaded ${slayerMonsters.length} slayer monsters into dropdown`);
        }

        // Generate complete slayer monster database and download monsters.js
        async function downloadFullMonsterList() {
            const progressContainer = document.getElementById('download-progress-container');
            const progressFill = document.getElementById('magic-progress-fill');
            
            // Show progress bar
            progressContainer.style.display = 'block';
            progressFill.style.width = '0%';
            
            try {
                // Progress stages for generating complete slayer database
                const stages = [
                    { progress: 20, message: 'Loading slayer monster data...', delay: 300 },
                    { progress: 40, message: 'Processing combat statistics...', delay: 400 },
                    { progress: 60, message: 'Adding drop tables...', delay: 500 },
                    { progress: 80, message: 'Formatting monster database...', delay: 400 },
                    { progress: 95, message: 'Generating monsters.js file...', delay: 300 },
                    { progress: 100, message: 'Download complete!', delay: 200 }
                ];
                
                for (const stage of stages) {
                    await new Promise(resolve => setTimeout(resolve, stage.delay));
                    progressFill.style.width = stage.progress + '%';
                    progressContainer.querySelector('div').textContent = stage.message;
                }
                
                // Create comprehensive slayer monster database
                const completeSlayerDatabase = createCompleteSlayerDatabase();
                console.log(`Generated ${Object.keys(completeSlayerDatabase).length} slayer monsters`);
                
                // Generate complete monsters.js file content
                const updatedMonstersJS = generateMonstersJSFile(completeSlayerDatabase);
                
                // Create and trigger download of updated monsters.js
                const blob = new Blob([updatedMonstersJS], { type: 'text/javascript;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'monsters.js');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                console.log(`Successfully generated monsters.js with ${Object.keys(completeSlayerDatabase).length} total monsters`);
                
                // Hide progress bar after completion
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                    alert(`Successfully generated complete monsters.js! Database now contains ${Object.keys(completeSlayerDatabase).length} monsters including all major slayer creatures. Please replace your current monsters.js file with the downloaded version.`);
                }, 1000);
                
            } catch (error) {
                console.error('Generation failed:', error);
                progressContainer.querySelector('div').textContent = 'Generation failed. Please try again.';
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                }, 3000);
            }
        }

        // Create comprehensive slayer monster database
        function createCompleteSlayerDatabase() {
            const slayerMonstersData = {
                // Low level slayer monsters (1-50)
                'crawling-hand': {
                    id: 'crawling-hand', name: 'Crawling Hand', combat_level: 8, hitpoints: 13, max_hit: 1,
                    slayer_level: 5, slayer_xp: 13, slayer_monster: true,
                    slayer_masters: ['turael', 'spria', 'vannaka', 'chaeldar'],
                    examine: 'Eek, a severed hand!',
                    locations: ['Slayer Tower']
                },
                'cave-bug': {
                    id: 'cave-bug', name: 'Cave bug', combat_level: 6, hitpoints: 8, max_hit: 1,
                    slayer_level: 7, slayer_xp: 8, slayer_monster: true,
                    slayer_masters: ['turael', 'spria', 'vannaka'],
                    examine: 'Not a bug you\'d want in your software.',
                    locations: ['Lumbridge Swamp Caves']
                },
                'cave-crawler': {
                    id: 'cave-crawler', name: 'Cave crawler', combat_level: 23, hitpoints: 23, max_hit: 2,
                    slayer_level: 10, slayer_xp: 23, slayer_monster: true,
                    slayer_masters: ['turael', 'spria', 'vannaka', 'chaeldar'],
                    examine: 'A nasty crawling creature.',
                    locations: ['Fremennik Slayer Dungeon']
                },
                'banshee': {
                    id: 'banshee', name: 'Banshee', combat_level: 23, hitpoints: 22, max_hit: 2,
                    slayer_level: 15, slayer_xp: 22, slayer_monster: true,
                    slayer_masters: ['turael', 'spria', 'vannaka', 'chaeldar'],
                    examine: 'A nasty undead creature.',
                    locations: ['Slayer Tower']
                },
                'cave-slime': {
                    id: 'cave-slime', name: 'Cave slime', combat_level: 23, hitpoints: 25, max_hit: 3,
                    slayer_level: 17, slayer_xp: 25, slayer_monster: true,
                    slayer_masters: ['turael', 'spria', 'vannaka', 'chaeldar'],
                    examine: 'Yuck!',
                    locations: ['Lumbridge Swamp Caves']
                },
                'rockslug': {
                    id: 'rockslug', name: 'Rockslug', combat_level: 29, hitpoints: 26, max_hit: 3,
                    slayer_level: 20, slayer_xp: 26, slayer_monster: true,
                    slayer_masters: ['turael', 'spria', 'vannaka', 'chaeldar'],
                    examine: 'Rock hard slug.',
                    locations: ['Fremennik Slayer Dungeon']
                },
                'cockatrice': {
                    id: 'cockatrice', name: 'Cockatrice', combat_level: 37, hitpoints: 35, max_hit: 4,
                    slayer_level: 25, slayer_xp: 35, slayer_monster: true,
                    slayer_masters: ['vannaka', 'chaeldar'],
                    examine: 'Half chicken, half dragon.',
                    locations: ['Fremennik Slayer Dungeon']
                },
                'pyrefiend': {
                    id: 'pyrefiend', name: 'Pyrefiend', combat_level: 43, hitpoints: 40, max_hit: 4,
                    slayer_level: 30, slayer_xp: 40, slayer_monster: true,
                    slayer_masters: ['vannaka', 'chaeldar'],
                    examine: 'A fiery creature.',
                    locations: ['Fremennik Slayer Dungeon']
                },
                'basilisk': {
                    id: 'basilisk', name: 'Basilisk', combat_level: 61, hitpoints: 75, max_hit: 5,
                    slayer_level: 40, slayer_xp: 75, slayer_monster: true,
                    slayer_masters: ['vannaka', 'chaeldar'],
                    examine: 'Its gaze turns people to stone.',
                    locations: ['Fremennik Slayer Dungeon']
                },
                'infernal-mage': {
                    id: 'infernal-mage', name: 'Infernal Mage', combat_level: 66, hitpoints: 65, max_hit: 11,
                    slayer_level: 45, slayer_xp: 65, slayer_monster: true,
                    slayer_masters: ['vannaka', 'chaeldar'],
                    examine: 'A mage of the infernal kind.',
                    locations: ['Slayer Tower']
                },

                // Mid level slayer monsters (50-75)
                'bloodveld': {
                    id: 'bloodveld', name: 'Bloodveld', combat_level: 76, hitpoints: 76, max_hit: 5,
                    slayer_level: 50, slayer_xp: 76.5, slayer_monster: true,
                    slayer_masters: ['vannaka', 'chaeldar', 'konar', 'nieve', 'duradel'],
                    examine: 'Eeek, what a horrible creature.',
                    locations: ['Slayer Tower', 'Catacombs of Kourend']
                },
                'jellies': {
                    id: 'jellies', name: 'Jelly', combat_level: 78, hitpoints: 75, max_hit: 5,
                    slayer_level: 52, slayer_xp: 75, slayer_monster: true,
                    slayer_masters: ['vannaka', 'chaeldar', 'konar', 'nieve'],
                    examine: 'It\'s all gooey.',
                    locations: ['Fremennik Slayer Dungeon']
                },
                'turoth': {
                    id: 'turoth', name: 'Turoth', combat_level: 83, hitpoints: 76, max_hit: 8,
                    slayer_level: 55, slayer_xp: 76, slayer_monster: true,
                    slayer_masters: ['vannaka', 'chaeldar', 'konar', 'nieve'],
                    examine: 'A terrifying creature.',
                    locations: ['Fremennik Slayer Dungeon']
                },
                'aberrant-spectre': {
                    id: 'aberrant-spectre', name: 'Aberrant spectre', combat_level: 96, hitpoints: 90, max_hit: 8,
                    slayer_level: 60, slayer_xp: 90, slayer_monster: true,
                    slayer_masters: ['vannaka', 'chaeldar', 'konar', 'nieve', 'duradel'],
                    examine: 'A ghastly spectre.',
                    locations: ['Slayer Tower', 'Catacombs of Kourend']
                },
                'dust-devil': {
                    id: 'dust-devil', name: 'Dust devil', combat_level: 93, hitpoints: 105, max_hit: 8,
                    slayer_level: 65, slayer_xp: 105, slayer_monster: true,
                    slayer_masters: ['vannaka', 'chaeldar', 'konar', 'nieve', 'duradel'],
                    examine: 'A whirling cloud of sandy doom.',
                    locations: ['Smoke Dungeon', 'Catacombs of Kourend']
                },
                'kurask': {
                    id: 'kurask', name: 'Kurask', combat_level: 106, hitpoints: 97, max_hit: 4,
                    slayer_level: 70, slayer_xp: 97, slayer_monster: true,
                    slayer_masters: ['chaeldar', 'konar', 'nieve', 'duradel'],
                    examine: 'Yuck, it\'s covered in slime.',
                    locations: ['Fremennik Slayer Dungeon']
                },
                'skeletal-wyvern': {
                    id: 'skeletal-wyvern', name: 'Skeletal Wyvern', combat_level: 140, hitpoints: 210, max_hit: 13,
                    slayer_level: 72, slayer_xp: 210, slayer_monster: true,
                    slayer_masters: ['konar', 'nieve', 'duradel'],
                    examine: 'Reanimated remains of an ancient wyvern.',
                    locations: ['Asgarnian Ice Dungeon']
                },
                'gargoyle': {
                    id: 'gargoyle', name: 'Gargoyle', combat_level: 111, hitpoints: 105, max_hit: 9,
                    slayer_level: 75, slayer_xp: 105, slayer_monster: true,
                    slayer_masters: ['chaeldar', 'konar', 'nieve', 'duradel'],
                    examine: 'An ugly stone creature.',
                    locations: ['Slayer Tower']
                },

                // High level slayer monsters (75+)
                'nechryael': {
                    id: 'nechryael', name: 'Nechryael', combat_level: 115, hitpoints: 105, max_hit: 7,
                    slayer_level: 80, slayer_xp: 105, slayer_monster: true,
                    slayer_masters: ['chaeldar', 'konar', 'nieve', 'duradel'],
                    examine: 'Eeew, it\'s all slimy.',
                    locations: ['Slayer Tower', 'Catacombs of Kourend']
                },
                'spiritual-mage': {
                    id: 'spiritual-mage', name: 'Spiritual mage', combat_level: 121, hitpoints: 75, max_hit: 16,
                    slayer_level: 83, slayer_xp: 75, slayer_monster: true,
                    slayer_masters: ['konar', 'nieve', 'duradel'],
                    examine: 'A spiritual manifestation of Saradomin.',
                    locations: ['God Wars Dungeon']
                },
                'abyssal-demon': {
                    id: 'abyssal-demon', name: 'Abyssal demon', combat_level: 124, hitpoints: 150, max_hit: 8,
                    slayer_level: 85, slayer_xp: 150, slayer_monster: true,
                    slayer_masters: ['vannaka', 'chaeldar', 'konar', 'nieve', 'duradel'],
                    examine: 'A denizen of the Abyss!',
                    locations: ['Slayer Tower', 'Catacombs of Kourend']
                },
                'cave-kraken': {
                    id: 'cave-kraken', name: 'Cave kraken', combat_level: 127, hitpoints: 125, max_hit: 28,
                    slayer_level: 87, slayer_xp: 125, slayer_monster: true,
                    slayer_masters: ['konar', 'nieve', 'duradel'],
                    examine: 'It looks kind of squiggly.',
                    locations: ['Kraken Cove']
                },
                'dark-beast': {
                    id: 'dark-beast', name: 'Dark beast', combat_level: 182, hitpoints: 220, max_hit: 15,
                    slayer_level: 90, slayer_xp: 220, slayer_monster: true,
                    slayer_masters: ['nieve', 'duradel'],
                    examine: 'A ferocious dark creature.',
                    locations: ['Temple of Light', 'Catacombs of Kourend']
                },
                'smoke-devil': {
                    id: 'smoke-devil', name: 'Smoke devil', combat_level: 160, hitpoints: 185, max_hit: 8,
                    slayer_level: 93, slayer_xp: 185, slayer_monster: true,
                    slayer_masters: ['nieve', 'duradel'],
                    examine: 'A devil made of smoke.',
                    locations: ['Smoke Devil Dungeon']
                },
                'hydra': {
                    id: 'hydra', name: 'Hydra', combat_level: 194, hitpoints: 420, max_hit: 17,
                    slayer_level: 95, slayer_xp: 420, slayer_monster: true,
                    slayer_masters: ['konar'],
                    examine: 'A many-headed beast.',
                    locations: ['Karuulm Slayer Dungeon']
                }
            };

            // Convert to full MonsterProperties objects
            const completeDatabase = {};
            
            Object.entries(slayerMonstersData).forEach(([key, data]) => {
                completeDatabase[key] = new MonsterProperties({
                    id: data.id,
                    name: data.name,
                    combat_level: data.combat_level,
                    hitpoints: data.hitpoints,
                    max_hit: data.max_hit,
                    attack_type: ['melee'],
                    attack_speed: 4,
                    aggressive: false,
                    poisonous: false,
                    venomous: false,
                    immune_poison: false,
                    immune_venom: false,
                    weaknesses: 'Varies by monster',
                    slayer_monster: data.slayer_monster,
                    slayer_level: data.slayer_level,
                    slayer_xp: data.slayer_xp,
                    slayer_masters: data.slayer_masters,
                    duplicate: false,
                    examine: data.examine,
                    wiki_name: data.name,
                    wiki_url: `https://oldschool.runescape.wiki/w/${encodeURIComponent(data.name.replace(/ /g, '_'))}`,
                    attack_level: Math.max(1, data.combat_level - 20),
                    strength_level: Math.max(1, data.combat_level - 20),
                    defence_level: Math.max(1, data.combat_level - 20),
                    magic_level: 1,
                    ranged_level: 1,
                    defence_stab: Math.max(0, data.combat_level - 30),
                    defence_slash: Math.max(0, data.combat_level - 30),
                    defence_crush: Math.max(0, data.combat_level - 30),
                    defence_magic: Math.max(0, data.combat_level - 40),
                    defence_ranged: Math.max(0, data.combat_level - 30),
                    locations: data.locations || [],
                    drops: []
                });
            });

            return completeDatabase;
        }

        // Generate complete monsters.js file content
        function generateMonstersJSFile(monsterDatabase) {
            let jsContent = `// OSRS Monster Database
// Complete monster data for slayer creatures
// Updated from OSRS Wiki: ${new Date().toISOString().split('T')[0]}

class MonsterDrop {
    constructor(id, name, members, quantity, noted, rarity, rolls) {
        this.id = id;
        this.name = name;
        this.members = members;
        this.quantity = quantity;
        this.noted = noted;
        this.rarity = rarity;
        this.rolls = rolls;
    }
}

class MonsterProperties {
    constructor(data) {
        this.id = data.id;
        this.name = data.name;
        this.combat_level = data.combat_level;
        this.hitpoints = data.hitpoints;
        this.max_hit = data.max_hit;
        this.attack_type = data.attack_type;
        this.attack_speed = data.attack_speed;
        this.aggressive = data.aggressive;
        this.poisonous = data.poisonous;
        this.venomous = data.venomous;
        this.immune_poison = data.immune_poison;
        this.immune_venom = data.immune_venom;
        this.weaknesses = data.weaknesses;
        this.slayer_monster = data.slayer_monster;
        this.slayer_level = data.slayer_level;
        this.slayer_xp = data.slayer_xp;
        this.slayer_masters = data.slayer_masters;
        this.duplicate = data.duplicate;
        this.examine = data.examine;
        this.wiki_name = data.wiki_name;
        this.wiki_url = data.wiki_url;
        this.attack_level = data.attack_level;
        this.strength_level = data.strength_level;
        this.defence_level = data.defence_level;
        this.magic_level = data.magic_level;
        this.ranged_level = data.ranged_level;
        this.attack_bonus = data.attack_bonus;
        this.strength_bonus = data.strength_bonus;
        this.attack_magic = data.attack_magic;
        this.magic_bonus = data.magic_bonus;
        this.attack_ranged = data.attack_ranged;
        this.ranged_bonus = data.ranged_bonus;
        this.defence_stab = data.defence_stab;
        this.defence_slash = data.defence_slash;
        this.defence_crush = data.defence_crush;
        this.defence_magic = data.defence_magic;
        this.defence_ranged = data.defence_ranged;
        this.drops = data.drops || [];
        this.locations = data.locations || [];
    }
}

// Monster Database
const MONSTER_DATABASE = {
`;

            // Add each monster to the database
            Object.entries(monsterDatabase).forEach(([key, monster]) => {
                jsContent += `    '${key}': new MonsterProperties({
        id: ${typeof monster.id === 'string' ? `'${monster.id}'` : monster.id},
        name: '${monster.name.replace(/'/g, "\\'")}',
        combat_level: ${monster.combat_level},
        hitpoints: ${monster.hitpoints},
        max_hit: ${monster.max_hit},
        attack_type: ${JSON.stringify(monster.attack_type)},
        attack_speed: ${monster.attack_speed},
        aggressive: ${monster.aggressive},
        poisonous: ${monster.poisonous},
        venomous: ${monster.venomous},
        immune_poison: ${monster.immune_poison},
        immune_venom: ${monster.immune_venom},
        weaknesses: '${monster.weaknesses.replace(/'/g, "\\'")}',
        slayer_monster: ${monster.slayer_monster},
        slayer_level: ${monster.slayer_level},
        slayer_xp: ${monster.slayer_xp},
        slayer_masters: ${JSON.stringify(monster.slayer_masters)},
        duplicate: ${monster.duplicate},
        examine: '${monster.examine.replace(/'/g, "\\'")}',
        wiki_name: '${monster.wiki_name.replace(/'/g, "\\'")}',
        wiki_url: '${monster.wiki_url}',
        attack_level: ${monster.attack_level},
        strength_level: ${monster.strength_level},
        defence_level: ${monster.defence_level},
        magic_level: ${monster.magic_level},
        ranged_level: ${monster.ranged_level},
        defence_stab: ${monster.defence_stab},
        defence_slash: ${monster.defence_slash},
        defence_crush: ${monster.defence_crush},
        defence_magic: ${monster.defence_magic},
        defence_ranged: ${monster.defence_ranged},
        locations: ${JSON.stringify(monster.locations)},
        drops: [${monster.drops.map(drop => 
            `new MonsterDrop(${drop.id}, '${drop.name.replace(/'/g, "\\'")}', ${drop.members}, '${drop.quantity}', ${drop.noted}, ${drop.rarity}, ${drop.rolls})`
        ).join(',\n            ')}]
    }),

`;
            });

            jsContent += `};

// Helper function to get all slayer monsters
function getSlayerMonsters() {
    return Object.values(MONSTER_DATABASE)
        .filter(monster => monster.slayer_monster && monster.slayer_level > 0)
        .sort((a, b) => a.slayer_level - b.slayer_level);
}

// Helper function to get monster by ID
function getMonsterById(id) {
    return MONSTER_DATABASE[id] || null;
}

// Helper function to format defense stats
function formatMonsterDefenses(monster) {
    return \`Stab: \${monster.defence_stab}, Slash: \${monster.defence_slash}, Crush: \${monster.defence_crush}, Magic: \${monster.defence_magic}, Ranged: \${monster.defence_ranged}\`;
}

// Helper function to format notable drops
function formatMonsterDrops(monster) {
    if (!monster.drops || monster.drops.length === 0) {
        return 'No notable drops';
    }
    
    // Get rare drops (rarity < 0.1)
    const rareDrops = monster.drops
        .filter(drop => drop.rarity < 0.1)
        .slice(0, 5)
        .map(drop => drop.name);
    
    if (rareDrops.length > 0) {
        return rareDrops.join(', ');
    }
    
    // If no rare drops, show common valuable drops
    return monster.drops
        .slice(0, 3)
        .map(drop => drop.name)
        .join(', ');
}

// Export for use in other files (if using modules)
if (typeof module !== 'undefined' && module.exports) {
    module.exports = {
        MONSTER_DATABASE,
        getSlayerMonsters,
        getMonsterById,
        formatMonsterDefenses,
        formatMonsterDrops
    };
}
`;

            return jsContent;
        }

        function createMonsterCSV(monsters) {
            const headers = [
                'Name', 'Combat Level', 'Hitpoints', 'Attack Level', 'Strength Level', 'Defence Level',
                'Magic Level', 'Ranged Level', 'Slayer Requirement', 'Slayer XP', 'Max Hit',
                'Attack Type', 'Weaknesses', 'Aggressive', 'Poisonous', 'Venomous',
                'Defence Stab', 'Defence Slash', 'Defence Crush', 'Defence Magic', 'Defence Ranged',
                'Examine', 'Wiki URL', 'Locations'
            ];
            
            let csvContent = headers.join(',') + '\n';
            
            monsters.forEach(monster => {
                const row = [
                    escapeCsvValue(monster.name || ''),
                    monster.combat_level || 0,
                    monster.hitpoints || 0,
                    monster.attack_level || 0,
                    monster.strength_level || 0,
                    monster.defence_level || 0,
                    monster.magic_level || 0,
                    monster.ranged_level || 0,
                    monster.slayer_level || 0,
                    monster.slayer_xp || 0,
                    monster.max_hit || 0,
                    escapeCsvValue(Array.isArray(monster.attack_type) ? monster.attack_type.join(';') : (monster.attack_type || '')),
                    escapeCsvValue(monster.weaknesses || ''),
                    monster.aggressive || false,
                    monster.poisonous || false,
                    monster.venomous || false,
                    monster.defence_stab || 0,
                    monster.defence_slash || 0,
                    monster.defence_crush || 0,
                    monster.defence_magic || 0,
                    monster.defence_ranged || 0,
                    escapeCsvValue(monster.examine || ''),
                    escapeCsvValue(monster.wiki_url || ''),
                    escapeCsvValue(Array.isArray(monster.locations) ? monster.locations.join(';') : '')
                ];
                csvContent += row.join(',') + '\n';
            });
            
            return csvContent;
        }

        function escapeCsvValue(value) {
            if (typeof value === 'string' && (value.includes(',') || value.includes('"') || value.includes('\n'))) {
                return '"' + value.replace(/"/g, '""') + '"';
            }
            return value;
        }

        // Potions functionality
        function populatePotionsTable() {
            console.log('Populating potions table...');
            
            // Check if potions database is available
            if (typeof getAllPotions === 'undefined') {
                console.error('Potions database not loaded!');
                return;
            }
            
            const potions = getAllPotions();
            console.log(`Found ${potions.length} potions in database`);
            
            displayPotions(potions);
        }

        function filterPotions() {
            const categoryFilter = document.getElementById('potion-category-filter').value;
            const levelFilter = parseInt(document.getElementById('potion-level-filter').value) || 1;
            
            let potions = getAllPotions();
            
            // Filter by category
            if (categoryFilter !== 'all') {
                potions = getPotionsByCategory(categoryFilter);
            }
            
            // Filter by level
            potions = potions.filter(potion => potion.level_required >= levelFilter);
            
            console.log(`Filtered to ${potions.length} potions (category: ${categoryFilter}, min level: ${levelFilter})`);
            displayPotions(potions);
        }

        function displayPotions(potions) {
            const tableBody = document.getElementById('potions-table-body');
            
            if (!tableBody) {
                console.error('Potions table body not found!');
                return;
            }
            
            tableBody.innerHTML = '';
            
            potions.forEach(potion => {
                const row = document.createElement('tr');
                
                // Create clickable potion name with wiki link
                const nameCell = document.createElement('td');
                nameCell.innerHTML = `<a href="${potion.getWikiUrl()}" target="_blank" class="wiki-link" style="color: #654321; text-decoration: none;">${potion.name}</a>`;
                row.appendChild(nameCell);
                
                // Level required
                const levelCell = document.createElement('td');
                levelCell.textContent = potion.level_required;
                levelCell.style.textAlign = 'center';
                row.appendChild(levelCell);
                
                // Ingredients
                const ingredientsCell = document.createElement('td');
                ingredientsCell.textContent = formatIngredients(potion);
                row.appendChild(ingredientsCell);
                
                // XP gained
                const xpCell = document.createElement('td');
                xpCell.textContent = potion.xp_gained;
                xpCell.style.textAlign = 'center';
                row.appendChild(xpCell);
                
                // Effect
                const effectCell = document.createElement('td');
                effectCell.textContent = potion.effect;
                effectCell.style.fontSize = '0.9em';
                row.appendChild(effectCell);
                
                // Add barbarian herblore indicator
                if (potion.barbarian_herblore) {
                    row.style.backgroundColor = 'rgba(139, 69, 19, 0.1)';
                    row.title = 'Barbarian Herblore training';
                }
                
                tableBody.appendChild(row);
            });
            
            console.log(`Displayed ${potions.length} potions in table`);
        }

        // Format monster locations with detailed information from locations database
        function formatMonsterLocations(monster) {
            if (!monster.locations || monster.locations.length === 0) {
                return 'No known locations';
            }

            const locationDetails = [];
            
            monster.locations.forEach(locationName => {
                // Try to find matching location in database by name
                const location = Object.values(LOCATIONS_DATABASE).find(loc => 
                    loc.name === locationName || 
                    locationName.toLowerCase().includes(loc.name.toLowerCase()) ||
                    loc.name.toLowerCase().includes(locationName.toLowerCase())
                );

                if (location) {
                    const teleports = location.teleports.length > 0 ? 
                        ` (${location.teleports.slice(0, 2).join(', ')})` : '';
                    
                    locationDetails.push(
                        `<a href="${location.wiki_url}" target="_blank" style="color: #8b4513; text-decoration: underline;">
                            <strong>${location.name}</strong>
                        </a>
                        <span style="color: #666; font-size: 0.9em;">${teleports}</span>
                        <div style="font-size: 0.8em; color: #555; margin-top: 2px;">
                            ${location.entrance_description}
                        </div>`
                    );
                } else {
                    // Fallback for locations not in database
                    const wikiUrl = `https://oldschool.runescape.wiki/w/${encodeURIComponent(locationName.replace(/ /g, '_'))}`;
                    locationDetails.push(
                        `<a href="${wikiUrl}" target="_blank" style="color: #8b4513; text-decoration: underline;">
                            ${locationName}
                        </a>`
                    );
                }
            });

            return locationDetails.join('<br><br>');
        }

        // Function to make specific items/locations clickable wiki links
        function makeLinksClickable(text) {
            // List of items and locations that should be wiki links
            const wikiTerms = [
                // Notable drops/items
                'Abyssal whip', 'Abyssal dagger', 'Granite maul', 'Trident of the seas', 'Dark bow',
                'Wyvern visage', 'Black mask', 'Dragon bones', 'Arclight', 'Silverlight', 'Brine sabre',
                'Dust battlestaff', 'Mystic boots', 'Mystic gloves', 'Occult necklace', 'Dragon boots',
                'Basilisk jaw', 'Granite legs', 'Granite shield', 'Obsidian items', 'Dragon chainbody',
                
                // Major locations
                'Slayer Tower', 'Catacombs of Kourend', 'Kraken Cove', 'Fremennik Slayer Dungeon',
                'Stronghold Slayer Cave', 'Brimhaven Dungeon', 'Asgarnian Ice Dungeon',
                'Taverley Dungeon', 'God Wars Dungeon', 'TzHaar City', 'Smoke Dungeon',
                'Smoke Devil Dungeon', 'Edgeville Dungeon', 'Karamja Volcano', 'Waterfall Dungeon',
                'Mourner Tunnels', 'Ancient Cavern', 'Stronghold of Security', 'Wilderness',
                'Varrock Sewers', 'Lumbridge Swamp Caves', 'Yanille Agility Dungeon',
                'Lizardman Settlement', 'Lizardman Caves', 'Waterbirth Island', 'Lighthouse',
                'Heroes\' Guild', 'Ogre Enclave', 'Evil Chicken\'s Lair', 'Crandor',
                'White Wolf Mountain', 'Wizard\'s Tower', 'Mos Le\'Harmless Cave',
                'Wyvern Cave', 'Fossil Island', 'Jormungand\'s Prison', 'Olaf\'s Quest dungeon',
                'Combat Training Camp', 'Watchtower', 'Feldip Hills', 'Trollheim',
                'Death Plateau', 'Jatizso', 'Legends\' Guild', 'Witchaven Dungeon',
                'Hill Giant area', 'Fishing Trawler'
            ];
            
            let linkedText = text;
            wikiTerms.forEach(term => {
                const regex = new RegExp(`\\b${term}\\b`, 'gi');
                linkedText = linkedText.replace(regex, `<span class="wiki-link" onclick="openWikiLink('${term}')">${term}</span>`);
            });
            
            return linkedText;
        }

        // Function to open OSRS Wiki links
        function openWikiLink(term) {
            const wikiUrl = `https://oldschool.runescape.wiki/w/${encodeURIComponent(term.replace(/\s+/g, '_'))}`;
            window.open(wikiUrl, '_blank');
        }

        // Equipment search functionality
        const equipmentItems = [
            { name: 'Dragon scimitar', slot: 'weapon' },
            { name: 'Amulet of fury', slot: 'amulet' },
            { name: 'Bandos chestplate', slot: 'body' },
            { name: 'Abyssal whip', slot: 'weapon' },
            { name: 'Fire cape', slot: 'cape' },
            { name: 'Dragon boots', slot: 'feet' },
            { name: 'Barrows gloves', slot: 'hands' },
            { name: 'Slayer helmet', slot: 'head' },
            { name: 'Dragon platelegs', slot: 'legs' },
            { name: 'Berserker ring', slot: 'ring' },
            { name: 'Dragon defender', slot: 'shield' },
            { name: 'Rune arrows', slot: 'ammo' },
            { name: 'Bandos tassets', slot: 'legs' },
            { name: 'Primordial boots', slot: 'feet' },
            { name: 'Amulet of torture', slot: 'amulet' },
            { name: 'Fighter torso', slot: 'body' },
            { name: 'Infernal cape', slot: 'cape' },
            { name: 'Void knight helm', slot: 'head' },
            { name: 'Granite maul', slot: 'weapon' },
            { name: 'Ring of wealth', slot: 'ring' },
            { name: 'Magic shortbow', slot: 'weapon' },
            { name: 'Dragon crossbow', slot: 'weapon' },
            { name: 'Obsidian cape', slot: 'cape' },
            { name: 'Combat bracelet', slot: 'hands' },
            { name: 'Dragon chainbody', slot: 'body' },
            { name: 'Rune platebody', slot: 'body' },
            { name: 'Mystic robe top', slot: 'body' },
            { name: 'Staff of fire', slot: 'weapon' },
            { name: 'Wizard hat', slot: 'head' },
            { name: 'Leather boots', slot: 'feet' }
        ];

        function searchItems() {
            const searchInput = document.getElementById('equipment-search');
            const resultsDiv = document.getElementById('search-results');
            
            // Return early if elements don't exist
            if (!searchInput || !resultsDiv) {
                return;
            }
            
            const query = searchInput.value.toLowerCase();
            
            if (query.length === 0) {
                resultsDiv.style.display = 'none';
                return;
            }
            
            const filteredItems = equipmentItems.filter(item => 
                item.name.toLowerCase().includes(query)
            );
            
            if (filteredItems.length > 0) {
                resultsDiv.innerHTML = '';
                filteredItems.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'search-result-item';
                    itemDiv.textContent = `${item.name} (${item.slot})`;
                    itemDiv.onclick = () => selectItem(item);
                    resultsDiv.appendChild(itemDiv);
                });
                resultsDiv.style.display = 'block';
            } else {
                resultsDiv.innerHTML = '<div class="search-result-item">No items found</div>';
                resultsDiv.style.display = 'block';
            }
        }

        function selectItem(item) {
            console.log('Selected item:', item);
            const searchInput = document.getElementById('equipment-search');
            const resultsDiv = document.getElementById('search-results');
            
            if (searchInput) {
                searchInput.value = item.name;
            }
            if (resultsDiv) {
                resultsDiv.style.display = 'none';
            }
            // TODO: Add functionality to equip item to gear slot
        }

        // Hide search results when clicking outside
        document.addEventListener('click', function(event) {
            const searchInput = document.getElementById('equipment-search');
            const resultsDiv = document.getElementById('search-results');
            
            // Only run if both elements exist
            if (searchInput && resultsDiv) {
                if (!searchInput.contains(event.target) && !resultsDiv.contains(event.target)) {
                    resultsDiv.style.display = 'none';
                }
            }
        });

        // Character lookup functionality
        // User lookup functionality removed - keeping only hiscores data structures
        // These functions are preserved for potential future hiscores integration
        
        // Note: fetchPlayerData, parseHiscoresData, and updateStatsPanel functions 
        // are kept below for potential future use


        // OSRS Hiscores API implementation
        
        // Skill names in the order they appear in the hiscores CSV
        const skillNames = [
            'overall', 'attack', 'defence', 'strength', 'hitpoints', 'ranged', 'prayer', 'magic',
            'cooking', 'woodcutting', 'fletching', 'fishing', 'firemaking', 'crafting', 'smithing',
            'mining', 'herblore', 'agility', 'thieving', 'slayer', 'farming', 'runecraft', 'hunter', 'construction'
        ];

        async function fetchPlayerData(username) {
            // Multiple CORS proxy fallbacks
            const proxies = [
                'https://corsproxy.io/?',
                'https://cors-anywhere.herokuapp.com/',
                'https://api.codetabs.com/v1/proxy?quest=',
                'https://thingproxy.freeboard.io/fetch/'
            ];
            
            const hiscoresUrl = `https://secure.runescape.com/m=hiscore_oldschool/index_lite.ws?player=${encodeURIComponent(username)}`;
            
            for (let i = 0; i < proxies.length; i++) {
                try {
                    console.log(`Trying proxy ${i + 1}/${proxies.length}: ${proxies[i]}`);
                    
                    let proxyUrl;
                    if (proxies[i].includes('codetabs')) {
                        proxyUrl = proxies[i] + encodeURIComponent(hiscoresUrl);
                    } else {
                        proxyUrl = proxies[i] + hiscoresUrl;
                    }
                    
                    const response = await fetch(proxyUrl, {
                        method: 'GET',
                        headers: {
                            'User-Agent': 'OSRS-Player-Dashboard/1.0'
                        }
                    });
                    
                    if (!response.ok) {
                        console.log(`Proxy ${i + 1} failed with status: ${response.status}`);
                        continue;
                    }
                    
                    const csvData = await response.text();
                    
                    // Validate that we got proper CSV data
                    if (csvData && csvData.includes(',') && !csvData.includes('<!DOCTYPE')) {
                        console.log(`Success with proxy ${i + 1}`);
                        return parseHiscoresData(csvData, username);
                    } else {
                        console.log(`Proxy ${i + 1} returned invalid data`);
                        continue;
                    }
                    
                } catch (error) {
                    console.log(`Proxy ${i + 1} error:`, error.message);
                    continue;
                }
            }
            
            // If all proxies fail, try direct fetch (will fail due to CORS, but worth trying)
            try {
                console.log('All proxies failed, trying direct fetch...');
                const response = await fetch(hiscoresUrl);
                if (response.ok) {
                    const csvData = await response.text();
                    return parseHiscoresData(csvData, username);
                }
            } catch (error) {
                console.log('Direct fetch failed as expected due to CORS');
            }
            
            throw new Error('Unable to fetch player data from OSRS Hiscores. All proxy services are currently unavailable.');
        }

        function parseHiscoresData(csvData, username) {
            const lines = csvData.trim().split('\n');
            const playerData = { username: username, skills: {} };
            
            // Parse each line: rank,level,xp
            lines.forEach((line, index) => {
                if (index < skillNames.length) {
                    const [rank, level, xp] = line.split(',');
                    const skillName = skillNames[index];
                    
                    playerData.skills[skillName] = {
                        rank: parseInt(rank) || -1,
                        level: parseInt(level) || 1,
                        xp: parseInt(xp) || 0
                    };
                }
            });
            
            return playerData;
        }
        
        // Lookup player function
        async function lookupPlayer() {
            const usernameInput = document.getElementById('username-input');
            const lookupBtn = document.getElementById('lookup-btn');
            const username = usernameInput.value.trim();
            
            if (!username) {
                alert('Please enter a username');
                return;
            }
            
            // Update button state
            lookupBtn.disabled = true;
            lookupBtn.textContent = 'Looking up...';
            
            try {
                console.log('Looking up player:', username);
                const playerData = await fetchPlayerData(username);
                updateStatsPanel(playerData);
                console.log('Player lookup successful:', playerData);
            } catch (error) {
                console.error('Error looking up player:', error);
                alert(`Error looking up player: ${error.message}`);
                
                // Reset page title on error
                const statsTitle = document.querySelector('#stats-tab h1');
                if (statsTitle) {
                    statsTitle.textContent = 'Player Stats';
                }
            } finally {
                // Reset button state
                lookupBtn.disabled = false;
                lookupBtn.textContent = 'Lookup Player';
            }
        }

        // Update stats panel with real player data
        function updateStatsPanel(playerData) {
            console.log('Updating stats panel with player data:', playerData);
            
            // Map skill names to their display order in our grid
            const skillMapping = {
                'attack': 0, 'strength': 1, 'defence': 2, 'ranged': 3, 'prayer': 4, 'magic': 5, 'runecraft': 6, 'construction': 7,
                'hitpoints': 8, 'agility': 9, 'herblore': 10, 'thieving': 11, 'crafting': 12, 'fletching': 13, 'slayer': 14, 'hunter': 15,
                'mining': 16, 'smithing': 17, 'fishing': 18, 'cooking': 19, 'firemaking': 20, 'woodcutting': 21, 'farming': 22
            };
            
            // Define max levels for each skill
            const skillMaxLevels = {
                'attack': 99, 'strength': 99, 'defence': 99, 'ranged': 99, 'prayer': 99, 'magic': 99, 'runecraft': 99, 'construction': 99,
                'hitpoints': 99, 'agility': 99, 'herblore': 99, 'thieving': 99, 'crafting': 99, 'fletching': 99, 'slayer': 99, 'hunter': 99,
                'mining': 99, 'smithing': 99, 'fishing': 18, 'cooking': 99, 'firemaking': 99, 'woodcutting': 99, 'farming': 99
            };
            
            const statItems = document.querySelectorAll('.stat-item .stat-level');
            
            Object.keys(skillMapping).forEach(skillName => {
                const index = skillMapping[skillName];
                const skillData = playerData.skills[skillName];
                
                if (skillData && statItems[index]) {
                    const level = skillData.level;
                    const maxLevel = skillMaxLevels[skillName];
                    statItems[index].textContent = `${level}/${maxLevel}`;
                    
                    // Add visual feedback for maxed skills
                    if (level >= maxLevel) {
                        statItems[index].style.color = '#d4af37'; // Gold color for maxed skills
                        statItems[index].style.fontWeight = 'bold';
                    } else {
                        statItems[index].style.color = '#654321'; // Default color
                        statItems[index].style.fontWeight = '600';
                    }
                }
            });
            
            // Update page title to show player name
            const statsTitle = document.querySelector('#stats-tab h1');
            if (statsTitle) {
                statsTitle.textContent = `${playerData.username}'s Stats`;
            }
        }



        // TODO: Logic to update gear item images from RuneLite or item database
        function updateGearPanel(playerData) {
            /*
            This function will update gear slots with actual equipped items
            Will fetch item images from OSRS wiki or item database
            Each slot will display the equipped item image and name on hover
            */
            console.log('Updating gear panel with equipment data');
        }


        // Achievement Diaries Data - loaded from diaries.js

        // Achievement Diary Functions
        let currentDiary = null;

        function openDiary(diaryId) {
            const diary = getDiaryById(diaryId);
            if (!diary) return;

            currentDiary = diaryId;
            document.getElementById('diary-main-view').style.display = 'none';
            document.getElementById('diary-detail-view').style.display = 'block';
            document.getElementById('difficulty-detail-view').style.display = 'none';
            document.getElementById('diary-title').textContent = diary.name;
        }

        function closeDiary() {
            document.getElementById('diary-detail-view').style.display = 'none';
            document.getElementById('difficulty-detail-view').style.display = 'none';
            document.getElementById('diary-main-view').style.display = 'block';
            currentDiary = null;
        }

        function showDifficulty(difficulty) {
            if (!currentDiary) return;
            
            const diary = getDiaryById(currentDiary);
            const difficultyData = diary.difficulties[difficulty];
            if (!difficultyData) return;

            document.getElementById('diary-detail-view').style.display = 'none';
            document.getElementById('difficulty-detail-view').style.display = 'block';
            
            const title = `${diary.name} - ${difficulty.charAt(0).toUpperCase() + difficulty.slice(1)}`;
            document.getElementById('difficulty-title').textContent = title;

            const content = `
                <div class="difficulty-requirements">
                    <h3>Tasks to Complete</h3>
                    <ul class="task-list">
                        ${difficultyData.tasks.map((task, index) => 
                            `<li>
                                <input type="checkbox" id="task-${currentDiary}-${difficulty}-${index}" 
                                       onchange="toggleTaskComplete('${currentDiary}', '${difficulty}', ${index})">
                                <label for="task-${currentDiary}-${difficulty}-${index}">${task.description}</label>
                                <button class="add-to-todo-btn" onclick="openTodoModal('diary', '${currentDiary}', '${difficulty}', ${index})">+ To-Do</button>
                            </li>`
                        ).join('')}
                    </ul>
                    
                    <div class="rewards-section">
                        <h4>Rewards</h4>
                        <p>${difficultyData.rewards.join(', ')}</p>
                    </div>
                </div>
            `;

            document.getElementById('difficulty-content').innerHTML = content;
            loadTaskProgress(currentDiary, difficulty);
        }

        function backToDiary() {
            document.getElementById('difficulty-detail-view').style.display = 'none';
            document.getElementById('diary-detail-view').style.display = 'block';
        }

        // New functions for dynamic diary system
        function populateDiaryTiles() {
            const diariesGrid = document.getElementById('diaries-grid');
            if (!diariesGrid) return;

            diariesGrid.innerHTML = '';
            
            const diaries = getAllDiaries();
            diaries.forEach(diary => {
                const progress = calculateDiaryProgress(diary.id);
                const tile = document.createElement('div');
                tile.className = 'diary-tile';
                tile.setAttribute('data-diary-id', diary.id);
                tile.onclick = () => openDiary(diary.id);
                
                tile.innerHTML = `
                    <div class="diary-icon">ðŸ“œ</div>
                    <h3>${diary.name}</h3>
                    <div class="diary-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress.percentage}%"></div>
                        </div>
                        <span class="progress-text">${progress.completed}/${progress.total} tasks</span>
                    </div>
                `;
                
                diariesGrid.appendChild(tile);
            });
        }

        function calculateDiaryProgress(diaryId) {
            const diary = getDiaryById(diaryId);
            let totalTasks = 0;
            let completedTasks = 0;

            Object.values(diary.difficulties).forEach(difficulty => {
                totalTasks += difficulty.tasks.length;
                difficulty.tasks.forEach((task, index) => {
                    if (isTaskCompleted(diaryId, Object.keys(diary.difficulties).find(key => diary.difficulties[key] === difficulty), index)) {
                        completedTasks++;
                    }
                });
            });

            return {
                completed: completedTasks,
                total: totalTasks,
                percentage: totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0
            };
        }

        function toggleTaskComplete(diaryId, difficulty, taskIndex) {
            const storageKey = `diary_${diaryId}_${difficulty}_${taskIndex}`;
            const isCompleted = localStorage.getItem(storageKey) === 'true';
            localStorage.setItem(storageKey, (!isCompleted).toString());
            
            // Update progress display if on main view
            if (document.getElementById('diary-main-view').style.display !== 'none') {
                populateDiaryTiles();
            }
        }

        function isTaskCompleted(diaryId, difficulty, taskIndex) {
            const storageKey = `diary_${diaryId}_${difficulty}_${taskIndex}`;
            return localStorage.getItem(storageKey) === 'true';
        }

        function loadTaskProgress(diaryId, difficulty) {
            const diary = getDiaryById(diaryId);
            const difficultyData = diary.difficulties[difficulty];
            
            difficultyData.tasks.forEach((task, index) => {
                const checkbox = document.getElementById(`task-${diaryId}-${difficulty}-${index}`);
                if (checkbox) {
                    checkbox.checked = isTaskCompleted(diaryId, difficulty, index);
                }
            });
        }

        function reloadDiaries() {
            console.log('Reloading achievement diaries...');
            populateDiaryTiles();
            console.log('Achievement diaries reloaded successfully!');
        }

        // Quest Database loaded from external file

        // Quest Functions
        let currentQuests = Object.keys(QUESTS_DATABASE);

        function initializeQuests() {
            filterQuests();
            updateQuestProgress();
        }

        function filterQuests() {
            const difficultyFilter = document.getElementById('quest-difficulty-filter').value;
            const searchTerm = document.getElementById('quest-search').value.toLowerCase();
            
            let filteredQuests = Object.keys(QUESTS_DATABASE);
            
            if (difficultyFilter !== 'all') {
                filteredQuests = filteredQuests.filter(questId => 
                    QUESTS_DATABASE[questId].difficulty === difficultyFilter
                );
            }
            
            if (searchTerm) {
                filteredQuests = filteredQuests.filter(questId => 
                    QUESTS_DATABASE[questId].name.toLowerCase().includes(searchTerm) ||
                    QUESTS_DATABASE[questId].description.toLowerCase().includes(searchTerm)
                );
            }
            
            displayQuests(filteredQuests);
        }

        function displayQuests(questIds) {
            const questList = document.getElementById('quest-list');
            questList.innerHTML = '';
            
            questIds.forEach(questId => {
                const quest = QUESTS_DATABASE[questId];
                const questItem = document.createElement('div');
                questItem.className = 'quest-item';
                questItem.setAttribute('data-quest-id', questId);
                questItem.onclick = () => openQuest(questId);
                
                questItem.innerHTML = `
                    <div class="quest-info">
                        <h3>${quest.name}</h3>
                        <p>${quest.description}</p>
                    </div>
                    <div class="quest-actions">
                        <span class="difficulty-badge ${quest.difficulty}">${quest.difficulty.charAt(0).toUpperCase() + quest.difficulty.slice(1)}</span>
                        <button class="add-to-todo-btn" onclick="event.stopPropagation(); openTodoModal('quest', '${questId}')">+ To-Do</button>
                    </div>
                `;
                
                questList.appendChild(questItem);
            });
        }

        function openQuest(questId) {
            const quest = QUESTS_DATABASE[questId];
            if (!quest) return;

            document.getElementById('quest-main-view').style.display = 'none';
            document.getElementById('quest-detail-view').style.display = 'block';
            
            document.getElementById('quest-title').textContent = quest.name;
            document.getElementById('quest-difficulty-badge').textContent = quest.difficulty.charAt(0).toUpperCase() + quest.difficulty.slice(1);
            document.getElementById('quest-difficulty-badge').className = `difficulty-badge ${quest.difficulty}`;

            const content = `
                <div class="quest-section">
                    <h3>Description</h3>
                    <p>${quest.description}</p>
                </div>

                <div class="quest-section">
                    <h3>Requirements</h3>
                    <ul class="item-list">
                        ${quest.requirements.length > 0 ? 
                            quest.requirements.map(req => `<li>${req}</li>`).join('') :
                            '<li>None</li>'
                        }
                    </ul>
                </div>

                <div class="quest-section">
                    <h3>Quick Guide</h3>
                    <p><a href="${quest.guide}" target="_blank" style="color: #8b4513; text-decoration: underline;">View Quick Guide on Wiki</a></p>
                </div>

                <div class="quest-section">
                    <h3>Rewards</h3>
                    <div class="reward-list">
                        ${quest.rewards.map(reward => `<div class="reward-item">${reward}</div>`).join('')}
                    </div>
                </div>

                <div class="quest-section">
                    <h3>Quest Info</h3>
                    <p><strong>Quest Points:</strong> ${quest.quest_points}</p>
                    <p><strong>Members:</strong> ${quest.members ? 'Yes' : 'No'}</p>
                    <p><strong>Combat Required:</strong> ${quest.combat_required ? 'Yes' : 'No'}</p>
                    <p><strong>Length:</strong> ${quest.official_length}</p>
                    <p><strong>Start Location:</strong> ${quest.start_location}</p>
                </div>

                <div class="quest-section">
                    <h3>Completion Status</h3>
                    <label class="completion-checkbox">
                        <input type="checkbox" id="quest-completed-${questId}" 
                               ${quest.completed ? 'checked' : ''} 
                               onchange="toggleQuestCompleted('${questId}')">
                        Mark as completed
                    </label>
                </div>
            `;

            document.getElementById('quest-content').innerHTML = content;
        }

        function toggleQuestCompleted(questId) {
            const completed = toggleQuestCompletion(questId);
            console.log(`${QUESTS_DATABASE[questId].name} marked as ${completed ? 'completed' : 'incomplete'}`);
            
            // Update the quest display
            filterQuests();
            updateQuestProgress();
        }

        function updateQuestProgress() {
            const progress = getQuestProgress();
            const questPoints = getTotalQuestPoints();
            const maxQuestPoints = getMaxQuestPoints();
            
            // Update any progress displays on the page
            const progressElements = document.querySelectorAll('.quest-progress');
            progressElements.forEach(element => {
                element.textContent = `${progress.completed}/${progress.total} quests completed (${progress.percentage}%) - ${questPoints}/${maxQuestPoints} Quest Points`;
            });
        }

        function closeQuest() {
            document.getElementById('quest-detail-view').style.display = 'none';
            document.getElementById('quest-main-view').style.display = 'block';
        }

        // Initialize quest list when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            loadNotes();
            // User lookup removed
            initializeQuests();
            populateDiaryTiles();
            
            const notesTextarea = document.getElementById('personal-notes');
            notesTextarea.addEventListener('input', function() {
                clearTimeout(this.saveTimeout);
                this.saveTimeout = setTimeout(() => {
                    saveNotes();
                }, 2000);
            });

            const usernameInput = document.getElementById('username-input');
            usernameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    lookupPlayer();
                }
            });
        });

        console.log('OSRS Player Dashboard with Achievement Diaries and Quests initialized');

        // ========== TO-DO LIST DATABASE ==========
        
        // IndexedDB database for persistent goal storage
        let goalsDB = null;
        const DB_NAME = 'OSRSGoalsDB';
        const DB_VERSION = 1;
        const GOALS_STORE = 'goals';
        const SELECTIONS_STORE = 'selections';
        
        /**
         * Initialize IndexedDB database
         */
        async function initializeGoalsDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => {
                    console.error('Failed to open IndexedDB:', request.error);
                    reject(request.error);
                };
                
                request.onsuccess = () => {
                    goalsDB = request.result;
                    console.log('IndexedDB initialized successfully');
                    resolve(goalsDB);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    // Create goals object store
                    if (!db.objectStoreNames.contains(GOALS_STORE)) {
                        const goalsStore = db.createObjectStore(GOALS_STORE, { keyPath: 'id' });
                        goalsStore.createIndex('category', 'category', { unique: false });
                        goalsStore.createIndex('difficulty', 'difficulty', { unique: false });
                        console.log('Created goals object store');
                    }
                    
                    // Create selections object store (for checked goals)
                    if (!db.objectStoreNames.contains(SELECTIONS_STORE)) {
                        const selectionsStore = db.createObjectStore(SELECTIONS_STORE, { keyPath: 'id' });
                        selectionsStore.createIndex('selected', 'selected', { unique: false });
                        console.log('Created selections object store');
                    }
                };
            });
        }

        /**
         * Add a goal to the database
         */
        async function addGoalToDB(goal) {
            if (!goalsDB) {
                console.log('Database not initialized, initializing now...');
                await initializeGoalsDatabase();
                if (!goalsDB) {
                    console.error('Failed to initialize database');
                    return false;
                }
            }
            
            return new Promise((resolve, reject) => {
                const transaction = goalsDB.transaction([GOALS_STORE], 'readwrite');
                const store = transaction.objectStore(GOALS_STORE);
                const request = store.put(goal);
                
                request.onsuccess = () => {
                    console.log('Goal added to database:', goal.id);
                    resolve(true);
                };
                
                request.onerror = () => {
                    console.error('Error adding goal to database:', request.error);
                    reject(request.error);
                };
            });
        }

        /**
         * Get all goals from the database
         */
        async function getAllGoalsFromDB() {
            if (!goalsDB) {
                console.log('Database not initialized, initializing now...');
                await initializeGoalsDatabase();
                if (!goalsDB) {
                    console.error('Failed to initialize database');
                    return [];
                }
            }
            
            return new Promise((resolve, reject) => {
                const transaction = goalsDB.transaction([GOALS_STORE], 'readonly');
                const store = transaction.objectStore(GOALS_STORE);
                const request = store.getAll();
                
                request.onsuccess = () => {
                    resolve(request.result || []);
                };
                
                request.onerror = () => {
                    console.error('Error getting goals from database:', request.error);
                    reject(request.error);
                };
            });
        }

        /**
         * Remove a goal from the database
         */
        async function removeGoalFromDB(goalId) {
            if (!goalsDB) {
                console.log('Database not initialized, initializing now...');
                await initializeGoalsDatabase();
                if (!goalsDB) {
                    console.error('Failed to initialize database');
                    return false;
                }
            }
            
            return new Promise((resolve, reject) => {
                const transaction = goalsDB.transaction([GOALS_STORE], 'readwrite');
                const store = transaction.objectStore(GOALS_STORE);
                const request = store.delete(goalId);
                
                request.onsuccess = () => {
                    console.log('Goal removed from database:', goalId);
                    resolve(true);
                };
                
                request.onerror = () => {
                    console.error('Error removing goal from database:', request.error);
                    reject(request.error);
                };
            });
        }

        /**
         * Save goal selection status
         */
        async function saveGoalSelection(goalId, selected) {
            if (!goalsDB) {
                console.log('Database not initialized, initializing now...');
                await initializeGoalsDatabase();
                if (!goalsDB) {
                    console.error('Failed to initialize database');
                    return false;
                }
            }
            
            return new Promise((resolve, reject) => {
                const transaction = goalsDB.transaction([SELECTIONS_STORE], 'readwrite');
                const store = transaction.objectStore(SELECTIONS_STORE);
                
                if (selected) {
                    const request = store.put({ id: goalId, selected: true, timestamp: Date.now() });
                    request.onsuccess = () => resolve(true);
                    request.onerror = () => reject(request.error);
                } else {
                    const request = store.delete(goalId);
                    request.onsuccess = () => resolve(true);
                    request.onerror = () => reject(request.error);
                }
            });
        }

        /**
         * Get all selected goal IDs
         */
        async function getSelectedGoalIds() {
            if (!goalsDB) {
                console.log('Database not initialized, initializing now...');
                await initializeGoalsDatabase();
                if (!goalsDB) {
                    console.error('Failed to initialize database');
                    return [];
                }
            }
            
            return new Promise((resolve, reject) => {
                const transaction = goalsDB.transaction([SELECTIONS_STORE], 'readonly');
                const store = transaction.objectStore(SELECTIONS_STORE);
                const request = store.getAll();
                
                request.onsuccess = () => {
                    const selections = request.result || [];
                    resolve(selections.map(s => s.id));
                };
                
                request.onerror = () => {
                    console.error('Error getting selections from database:', request.error);
                    reject(request.error);
                };
            });
        }

        /**
         * Migrate existing localStorage data to IndexedDB
         */
        async function migrateLocalStorageToDB() {
            try {
                // Check if localStorage data exists
                const savedIds = JSON.parse(localStorage.getItem('osrsToDoList') || '[]');
                if (savedIds.length === 0) {
                    console.log('No localStorage data to migrate');
                    return;
                }

                console.log('Migrating', savedIds.length, 'selections to IndexedDB');
                
                // Save each selection to the database
                for (const goalId of savedIds) {
                    await saveGoalSelection(goalId, true);
                }
                
                console.log('Migration completed successfully');
                
                // Clear old localStorage data after successful migration
                localStorage.removeItem('osrsToDoList');
                
            } catch (error) {
                console.error('Error during migration:', error);
            }
        }

        // ========== TO-DO LIST FUNCTIONALITY ==========
        
        // Master goals list to hold all standardized goals (now backed by IndexedDB)
        let masterGoalsList = [];
        
        /**
         * Populate the master goals list from existing data arrays and database
         * This function runs once to aggregate all available goals
         */
        async function populateMasterGoalsList(retryCount = 0) {
            masterGoalsList = []; // Clear existing list
            
            // Check if quest data is available (QUESTS_DATABASE is defined in quests.js)
            const questDataAvailable = typeof QUESTS_DATABASE !== 'undefined';
            
            if (!questDataAvailable && retryCount < 10) {
                console.log(`Quest data not yet available, retrying in 500ms... (attempt ${retryCount + 1}/10)`);
                setTimeout(() => populateMasterGoalsList(retryCount + 1), 500);
                return;
            }
            
            // If we've exceeded retry limit, proceed with just database goals
            if (!questDataAvailable && retryCount >= 10) {
                console.warn('Quest data failed to load after 10 attempts, proceeding with database goals only');
            }

            try {
                // Initialize database first
                if (!goalsDB) {
                    await initializeGoalsDatabase();
                    // Migrate existing localStorage data if it exists
                    await migrateLocalStorageToDB();
                }

                // Load existing goals from database
                const existingGoals = await getAllGoalsFromDB();
                console.log(`Loaded ${existingGoals.length} goals from database`);
                
                // Create a map for quick lookup
                const existingGoalIds = new Set(existingGoals.map(g => g.id));
                masterGoalsList = [...existingGoals];

                // Note: Quests are no longer auto-populated. They are created on-demand when manually added.

                // Add Achievement Diaries to master list (if available)
                if (window.ACHIEVEMENT_DIARIES_DATABASE) {
                    for (const diary of Object.values(window.ACHIEVEMENT_DIARIES_DATABASE)) {
                        for (const [index, task] of diary.tasks.entries()) {
                            const goalId = `diary_${diary.id}_${index}`;
                            if (!existingGoalIds.has(goalId)) {
                                const requiredItems = extractRequiredItems([task.description]);
                                const requiredSkills = extractRequiredSkills([task.description]);
                                
                                const goalData = {
                                    id: goalId,
                                    name: `${diary.name} - ${task.difficulty}: ${task.description}`,
                                    category: 'Achievement Diary',
                                    difficulty: task.difficulty,
                                    requiredItems: requiredItems,
                                    requiredSkills: requiredSkills,
                                    region: diary.region
                                };
                                
                                masterGoalsList.push(goalData);
                                await addGoalToDB(goalData);
                            }
                        }
                    }
                }

                // Add Slayer monsters to master list (if available)
                if (window.SLAYER_MONSTERS_DATABASE) {
                    for (const monster of Object.values(window.SLAYER_MONSTERS_DATABASE)) {
                        const goalId = `slayer_${monster.id}`;
                        if (!existingGoalIds.has(goalId)) {
                            const requiredItems = extractRequiredItems(monster.notes ? [monster.notes] : []);
                            const requiredSkills = [{ skill: 'Slayer', level: monster.slayer_level }];
                            
                            const goalData = {
                                id: goalId,
                                name: `Slay ${monster.name}`,
                                category: 'Slayer',
                                difficulty: monster.slayer_level >= 70 ? 'high' : monster.slayer_level >= 40 ? 'medium' : 'low',
                                requiredItems: requiredItems,
                                requiredSkills: requiredSkills,
                                slayerLevel: monster.slayer_level
                            };
                            
                            masterGoalsList.push(goalData);
                            await addGoalToDB(goalData);
                        }
                    }
                }
                
                console.log(`Master goals list populated with ${masterGoalsList.length} goals`);
                
                // Now populate the UI
                await populateGoalsList();
                
                // Load saved selections and update UI
                await loadToDoList();
                
            } catch (error) {
                console.error('Error populating master goals list:', error);
                // Retry once more
                setTimeout(populateMasterGoalsList, 1000);
            }
        }

        /**
         * Extract required items from requirement strings
         * @param {Array} requirements - Array of requirement strings
         * @returns {Array} Array of required item names
         */
        function extractRequiredItems(requirements) {
            const items = [];
            const itemKeywords = [
                'hammer', 'saw', 'nails', 'logs', 'planks', 'rope', 'tinderbox',
                'knife', 'needle', 'thread', 'chisel', 'pickaxe', 'axe', 'fishing rod',
                'net', 'bait', 'feathers', 'arrow', 'bow', 'sword', 'armor', 'shield',
                'potion', 'food', 'rune', 'talisman', 'orb', 'staff', 'gloves', 'boots',
                'helmet', 'coins', 'gp', 'key', 'scroll', 'book', 'crystal', 'gem'
            ];

            if (!requirements || !Array.isArray(requirements)) return items;

            requirements.forEach(req => {
                if (typeof req === 'string') {
                    const lower = req.toLowerCase();
                    itemKeywords.forEach(item => {
                        if (lower.includes(item) && !items.includes(item)) {
                            items.push(item);
                        }
                    });
                }
            });

            return items;
        }

        /**
         * Extract required skills from requirement strings
         * @param {Array} requirements - Array of requirement strings
         * @returns {Array} Array of {skill, level} objects
         */
        function extractRequiredSkills(requirements) {
            const skills = [];
            const skillNames = [
                'Attack', 'Strength', 'Defence', 'Ranged', 'Prayer', 'Magic',
                'Runecrafting', 'Construction', 'Hitpoints', 'Agility', 'Herblore',
                'Thieving', 'Crafting', 'Fletching', 'Slayer', 'Hunter', 'Mining',
                'Smithing', 'Fishing', 'Cooking', 'Firemaking', 'Woodcutting', 'Farming'
            ];

            if (!requirements || !Array.isArray(requirements)) return skills;

            requirements.forEach(req => {
                if (typeof req === 'string') {
                    // Look for patterns like "60 Mining", "Level 50 Magic", etc.
                    const matches = req.match(/(\d+)\s+(\w+)|(\w+)\s+(\d+)|Level\s+(\d+)\s+(\w+)/gi);
                    if (matches) {
                        matches.forEach(match => {
                            skillNames.forEach(skillName => {
                                if (match.toLowerCase().includes(skillName.toLowerCase())) {
                                    const levelMatch = match.match(/\d+/);
                                    if (levelMatch) {
                                        const level = parseInt(levelMatch[0]);
                                        const existing = skills.find(s => s.skill === skillName);
                                        if (!existing || existing.level < level) {
                                            if (existing) {
                                                existing.level = level;
                                            } else {
                                                skills.push({ skill: skillName, level: level });
                                            }
                                        }
                                    }
                                }
                            });
                        });
                    }
                }
            });

            return skills;
        }

        /**
         * Populate the goals list UI with checkboxes organized by category
         */
        async function populateGoalsList() {
            const container = document.getElementById('master-goals-list');
            if (!container) return;
            
            // Get only selected goals
            const selectedIds = await getSelectedGoalIds();
            const selectedGoals = selectedIds.map(id => masterGoalsList.find(goal => goal.id === id)).filter(Boolean);
            
            if (selectedGoals.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; margin-top: 50px;">No goals added yet. Add goals from the Quest or Achievement Diary tabs.</p>';
                return;
            }
            
            // Group selected goals by category
            const groupedGoals = {};
            selectedGoals.forEach(goal => {
                if (!groupedGoals[goal.category]) {
                    groupedGoals[goal.category] = [];
                }
                groupedGoals[goal.category].push(goal);
            });
            
            // Sort categories for consistent display
            const categoryOrder = ['Quest', 'Miniquest', 'Achievement Diary', 'Slayer'];
            const sortedCategories = Object.keys(groupedGoals).sort((a, b) => {
                const aIndex = categoryOrder.indexOf(a);
                const bIndex = categoryOrder.indexOf(b);
                return (aIndex === -1 ? 999 : aIndex) - (bIndex === -1 ? 999 : bIndex);
            });

            let html = '';
            sortedCategories.forEach(category => {
                const goals = groupedGoals[category];
                html += `<div class="goal-category">`;
                html += `<h4>${category} (${goals.length})</h4>`;
                
                // Sort goals within category
                goals.sort((a, b) => a.name.localeCompare(b.name));
                
                goals.forEach(goal => {
                    html += `
                        <div class="goal-item">
                            <div style="display: flex; align-items: center; flex: 1;">
                                <span class="goal-label">
                                    ${goal.name}
                                    ${goal.questPoints ? `(${goal.questPoints} QP)` : ''}
                                    ${goal.slayerLevel ? `(${goal.slayerLevel} Slayer)` : ''}
                                </span>
                            </div>
                            <button class="remove-goal-btn" onclick="openRemoveModal('${goal.id}')" title="Remove from To-Do list">Remove</button>
                        </div>
                    `;
                });
                
                html += `</div>`;
            });

            container.innerHTML = html;
        }

        /**
         * Update the requirements display based on selected goals
         */
        async function updateRequirements() {
            const selectedGoalIds = await getSelectedGoalIds();
            const container = document.querySelector('.requirements-grid');
            
            if (!container) {
                console.warn('Requirements grid container not found');
                return;
            }
            
            console.log('Updating requirements for goals:', selectedGoalIds);
            
            // Aggregate skill requirements from selected goals
            const allSkills = {};
            
            selectedGoalIds.forEach(goalId => {
                const goal = masterGoalsList.find(g => g.id === goalId);
                if (!goal) {
                    console.warn('Goal not found:', goalId);
                    return;
                }
                
                console.log('Processing goal:', goal.name, 'with skills:', goal.requiredSkills);
                
                // Ensure requiredSkills exists and is an array
                if (goal.requiredSkills && Array.isArray(goal.requiredSkills)) {
                    goal.requiredSkills.forEach(skillReq => {
                        if (skillReq && skillReq.skill && skillReq.level) {
                            const skillName = skillReq.skill.toLowerCase();
                            const existing = allSkills[skillName];
                            if (!existing || existing < skillReq.level) {
                                allSkills[skillName] = skillReq.level;
                            }
                        }
                    });
                }
            });
            
            console.log('Aggregated skills:', allSkills);
            
            // Define all skills in the same order as stats tab
            const allSkillsArray = [
                // Column 1
                'attack', 'strength', 'defence', 'ranged', 'prayer', 'magic', 'runecraft', 'construction',
                // Column 2  
                'hitpoints', 'agility', 'herblore', 'thieving', 'crafting', 'fletching', 'slayer', 'hunter',
                // Column 3
                'mining', 'smithing', 'fishing', 'cooking', 'firemaking', 'woodcutting', 'farming'
            ];
            
            // Always show all skills (required ones highlighted)
            let html = '';
            allSkillsArray.forEach(skillName => {
                const requiredLevel = allSkills[skillName];
                const isRequired = requiredLevel && requiredLevel > 0;
                const skillDisplayName = skillName.charAt(0).toUpperCase() + skillName.slice(1);
                
                html += `
                    <div class="requirement-item ${isRequired ? 'required' : ''}">
                        <img src="https://oldschool.runescape.wiki/images/${skillDisplayName}_icon.png" 
                             alt="${skillDisplayName}" class="stat-icon">
                        <span class="requirement-level">
                            ${isRequired ? `${requiredLevel}` : '--'}
                        </span>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Show message if no requirements
            if (Object.keys(allSkills).length === 0) {
                console.log('No skill requirements found');
            }
        }

        /**
         * Save selected goals to database
         */
        async function saveToDoList() {
            try {
                const checkedGoals = document.querySelectorAll('.goal-checkbox:checked');
                const selectedIds = Array.from(checkedGoals).map(cb => cb.dataset.goalId);
                
                // Get currently selected IDs from database
                const currentlySelected = await getSelectedGoalIds();
                
                // Find goals to add and remove
                const toAdd = selectedIds.filter(id => !currentlySelected.includes(id));
                const toRemove = currentlySelected.filter(id => !selectedIds.includes(id));
                
                // Update database
                for (const goalId of toAdd) {
                    await saveGoalSelection(goalId, true);
                }
                for (const goalId of toRemove) {
                    await saveGoalSelection(goalId, false);
                }
                
                console.log('To-Do list saved to database');
            } catch (error) {
                console.error('Error saving To-Do list:', error);
            }
        }

        /**
         * Recreate custom skill goals from localStorage
         */
        function recreateCustomSkillGoals() {
            try {
                const savedIds = JSON.parse(localStorage.getItem('osrsToDoList') || '[]');
                console.log('Recreating custom skill goals from saved IDs:', savedIds);
                
                // Check for custom skill goals that aren't in the master list and recreate them
                savedIds.forEach(goalId => {
                    const existingGoal = masterGoalsList.find(goal => goal.id === goalId);
                    if (!existingGoal && goalId.startsWith('skill_goal_')) {
                        // Recreate custom skill goal from saved ID
                        const parts = goalId.replace('skill_goal_', '').split('_');
                        if (parts.length >= 2) {
                            const skillName = parts[0];
                            const targetLevel = parseInt(parts[1]);
                            
                            if (skillName && targetLevel && targetLevel > 0 && targetLevel <= 99) {
                                const skillNameCapitalized = skillName.charAt(0).toUpperCase() + skillName.slice(1);
                                const recreatedGoal = {
                                    id: goalId,
                                    name: `Train ${skillNameCapitalized} to level ${targetLevel}`,
                                    category: 'Skill Goal',
                                    difficulty: 'custom',
                                    requiredItems: [],
                                    requiredSkills: [{ skill: skillNameCapitalized, level: targetLevel }]
                                };
                                
                                masterGoalsList.push(recreatedGoal);
                                console.log('Recreated custom skill goal:', recreatedGoal);
                            }
                        }
                    }
                });
                
                // Remove any duplicate goals that might have been created
                const uniqueGoals = [];
                const seenIds = new Set();
                masterGoalsList.forEach(goal => {
                    if (!seenIds.has(goal.id)) {
                        uniqueGoals.push(goal);
                        seenIds.add(goal.id);
                    }
                });
                masterGoalsList.length = 0;
                masterGoalsList.push(...uniqueGoals);
                
            } catch (error) {
                console.error('Error recreating custom skill goals:', error);
            }
        }

        /**
         * Load selected goals from IndexedDB
         */
        async function loadToDoList() {
            try {
                const savedIds = await getSelectedGoalIds();
                console.log('Loading selected goal IDs from database:', savedIds);
                
                // Update button states for selected goals
                savedIds.forEach(goalId => {
                    updateButtonStateFromGoalId(goalId, true);
                });
                
                // Update requirements display
                await updateRequirements();
                
                console.log(`Loaded ${savedIds.length} saved goals from database`);
            } catch (error) {
                console.error('Error loading To-Do list:', error);
            }
        }

        /**
         * Update button state from goal ID (helper function for loading)
         * @param {string} goalId - The goal ID
         * @param {boolean} added - Whether the goal is added
         */
        function updateButtonStateFromGoalId(goalId, added) {
            try {
                if (goalId.startsWith('quest_')) {
                    const questId = goalId.replace('quest_', '');
                    updateButtonState('quest', questId, null, null, added, goalId);
                } else if (goalId.startsWith('diary_')) {
                    // Parse diary goal ID: diary_diaryId_difficulty_taskIndex
                    const parts = goalId.replace('diary_', '').split('_');
                    if (parts.length >= 3) {
                        const diaryId = parts[0];
                        const difficulty = parts[1];
                        const taskIndex = parseInt(parts[2]);
                        updateButtonState('diary', diaryId, difficulty, taskIndex, added, goalId);
                    }
                } else if (goalId.startsWith('skill_goal_')) {
                    // Parse skill goal ID: skill_goal_skillName_level
                    const parts = goalId.replace('skill_goal_', '').split('_');
                    if (parts.length >= 1) {
                        const skillName = parts[0];
                        updateButtonState('skill', skillName, null, null, added, goalId);
                    }
                }
            } catch (error) {
                console.error('Error updating button state from goal ID:', error);
            }
        }

        // Initialize To-Do List when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Wait a bit for other data to load first
            setTimeout(populateMasterGoalsList, 1000);
        });

        // Also initialize when switching to the todo tab
        const originalSwitchTab = switchTab;
        switchTab = function(page, tabName, buttonElement) {
            originalSwitchTab(page, tabName, buttonElement);
            if (tabName === 'todo') {
                initializeToDoTab();
            }
        };

        function initializeToDoTab() {
            if (masterGoalsList.length === 0) {
                populateMasterGoalsList();
            }
        }

        // ========== MODAL FUNCTIONALITY ==========
        
        // Store current modal data
        let currentModalData = null;

        /**
         * Open the To-Do modal with item information
         * @param {string} type - The type of item ('quest', 'diary', 'skill')
         * @param {string} itemId - The ID of the item
         * @param {string} difficulty - (diary only) The difficulty level
         * @param {number} taskIndex - (diary only) The task index
         */
        function openTodoModal(type, itemId, difficulty = null, taskIndex = null) {
            const modal = document.getElementById('todo-modal');
            const nameElement = document.getElementById('modal-item-name');
            const descElement = document.getElementById('modal-item-description');
            const detailsElement = document.getElementById('modal-item-details');

            // Store current data for confirmation
            currentModalData = { type, itemId, difficulty, taskIndex };

            try {
                if (type === 'quest') {
                    const quest = typeof QUESTS_DATABASE !== 'undefined' ? QUESTS_DATABASE[itemId] : null;
                    if (quest) {
                        nameElement.textContent = quest.name;
                        descElement.textContent = quest.description;
                        detailsElement.innerHTML = `
                            <p><strong>Difficulty:</strong> ${quest.difficulty}</p>
                            <p><strong>Quest Points:</strong> ${quest.quest_points}</p>
                            <p><strong>Members:</strong> ${quest.members ? 'Yes' : 'No'}</p>
                            <p><strong>Combat Required:</strong> ${quest.combat_required ? 'Yes' : 'No'}</p>
                            ${quest.requirements && quest.requirements.length > 0 ? 
                                `<p><strong>Requirements:</strong> ${quest.requirements.join(', ')}</p>` : ''}
                        `;
                    } else {
                        nameElement.textContent = 'Quest';
                        descElement.textContent = 'Quest information not available.';
                        detailsElement.innerHTML = '';
                    }
                } else if (type === 'diary') {
                    const diary = window.ACHIEVEMENT_DIARIES_DATABASE ? 
                                  Object.values(window.ACHIEVEMENT_DIARIES_DATABASE).find(d => d.id === itemId) : null;
                    if (diary && diary.difficulties && diary.difficulties[difficulty] && 
                        diary.difficulties[difficulty].tasks[taskIndex]) {
                        const task = diary.difficulties[difficulty].tasks[taskIndex];
                        nameElement.textContent = `${diary.name} - ${difficulty.charAt(0).toUpperCase() + difficulty.slice(1)}`;
                        descElement.textContent = task.description;
                        detailsElement.innerHTML = `
                            <p><strong>Difficulty:</strong> ${difficulty}</p>
                            <p><strong>Region:</strong> ${diary.region}</p>
                            <p><strong>Task:</strong> ${task.description}</p>
                        `;
                    } else {
                        nameElement.textContent = 'Achievement Diary Task';
                        descElement.textContent = 'Diary task information not available.';
                        detailsElement.innerHTML = '';
                    }
                } else if (type === 'skill') {
                    const skillName = itemId.charAt(0).toUpperCase() + itemId.slice(1);
                    nameElement.textContent = `${skillName} Training Goal`;
                    descElement.textContent = `Set a training goal for your ${skillName} skill.`;
                    detailsElement.innerHTML = `
                        <p><strong>Skill:</strong> ${skillName}</p>
                        <p><strong>Type:</strong> Skill Training Goal</p>
                        <p>This will add a customizable ${skillName} training goal to your To-Do list.</p>
                    `;
                    
                    // Show skill level input and get current level
                    const skillLevelInput = document.getElementById('skill-level-input');
                    const targetLevelInput = document.getElementById('target-level');
                    const currentLevelSpan = document.getElementById('current-level');
                    
                    skillLevelInput.style.display = 'block';
                    
                    // Get current skill level from stats
                    const currentLevel = getCurrentSkillLevel(itemId);
                    console.log('Current level for', itemId, ':', currentLevel);
                    currentLevelSpan.textContent = currentLevel;
                    
                    // Set minimum and default values
                    targetLevelInput.min = currentLevel;
                    const defaultValue = currentLevel >= 99 ? 99 : currentLevel + 1;
                    targetLevelInput.value = defaultValue;
                    console.log('Set default value to:', defaultValue, 'for current level:', currentLevel);
                    
                    // Remove any existing event handlers
                    targetLevelInput.oninput = null;
                    targetLevelInput.onchange = null;
                    
                    // Add input validation only when user finishes editing (onchange instead of oninput)
                    targetLevelInput.onchange = function() {
                        const value = parseInt(this.value);
                        console.log('Level input changed to:', value, 'Current level:', currentLevel);
                        
                        if (isNaN(value) || value < currentLevel) {
                            console.log('Setting to current level:', currentLevel);
                            this.value = currentLevel;
                        } else if (value > 99) {
                            console.log('Setting to max level: 99');
                            this.value = 99;
                        } else {
                            console.log('Valid level entered:', value);
                        }
                    };
                    
                    // Also add a blur event as backup
                    targetLevelInput.onblur = function() {
                        const value = parseInt(this.value);
                        if (isNaN(value) || value < currentLevel) {
                            this.value = currentLevel;
                        } else if (value > 99) {
                            this.value = 99;
                        }
                    };
                }

                // Show the modal
                modal.style.display = 'block';

            } catch (error) {
                console.error('Error opening modal:', error);
                nameElement.textContent = 'Item';
                descElement.textContent = 'Item information could not be loaded.';
                detailsElement.innerHTML = '';
                modal.style.display = 'block';
            }
        }

        /**
         * Close the To-Do modal
         */
        function closeTodoModal() {
            const modal = document.getElementById('todo-modal');
            const skillLevelInput = document.getElementById('skill-level-input');
            
            modal.style.display = 'none';
            skillLevelInput.style.display = 'none'; // Hide skill input
            currentModalData = null;
        }
        
        // Store current goal data for removal
        let currentRemoveGoalData = null;
        
        /**
         * Open the remove confirmation modal
         * @param {string} goalId - The ID of the goal to remove
         */
        function openRemoveModal(goalId) {
            const goal = masterGoalsList.find(g => g.id === goalId);
            if (!goal) {
                console.error('Goal not found for removal:', goalId);
                return;
            }
            
            const modal = document.getElementById('remove-modal');
            const nameElement = document.getElementById('remove-modal-item-name');
            const descElement = document.getElementById('remove-modal-item-description');
            
            // Store goal data for confirmation
            currentRemoveGoalData = { goalId, goal };
            
            // Populate modal with goal information
            nameElement.textContent = goal.name;
            descElement.textContent = `${goal.category}${goal.questPoints ? ` (${goal.questPoints} QP)` : ''}${goal.slayerLevel ? ` (${goal.slayerLevel} Slayer)` : ''}`;
            
            // Show modal
            modal.style.display = 'flex';
        }
        
        /**
         * Close the remove confirmation modal
         */
        function closeRemoveModal() {
            const modal = document.getElementById('remove-modal');
            modal.style.display = 'none';
            currentRemoveGoalData = null;
        }
        
        /**
         * Confirm removal of the goal
         */
        async function confirmRemoveGoal() {
            if (!currentRemoveGoalData) return;
            
            const { goalId, goal } = currentRemoveGoalData;
            
            try {
                // Remove selection from database
                await saveGoalSelection(goalId, false);
                
                // Refresh the to-do list to remove the item from UI
                await populateGoalsList();
                
                // Update requirements display
                await updateRequirements();
                
                // Update button states
                resetButtonState(goalId);
                
                console.log(`Removed "${goal.name}" from To-Do list`);
                showToDoFeedback('Removed from To-Do list', 'success');
                
                // Close modal
                closeRemoveModal();
                
            } catch (error) {
                console.error('Error removing goal:', error);
                showToDoFeedback('Error removing from To-Do list', 'error');
            }
        }

        /**
         * Get current skill level from stats display
         * @param {string} skillName - The skill name (lowercase)
         * @returns {number} Current skill level
         */
        function getCurrentSkillLevel(skillName) {
            try {
                // Map skill names to their position in the stats grid
                const skillMapping = {
                    'attack': 0, 'strength': 1, 'defence': 2, 'ranged': 3, 'prayer': 4, 'magic': 5, 'runecraft': 6, 'construction': 7,
                    'hitpoints': 8, 'agility': 9, 'herblore': 10, 'thieving': 11, 'crafting': 12, 'fletching': 13, 'slayer': 14, 'hunter': 15,
                    'mining': 16, 'smithing': 17, 'fishing': 18, 'cooking': 19, 'firemaking': 20, 'woodcutting': 21, 'farming': 22
                };

                const index = skillMapping[skillName.toLowerCase()];
                if (index !== undefined) {
                    const statItems = document.querySelectorAll('.stat-level');
                    if (statItems && statItems[index]) {
                        const levelText = statItems[index].textContent || '';
                        const match = levelText.match(/(\d+)/);
                        if (match) {
                            const currentLevel = parseInt(match[0]);
                            return Math.max(1, Math.min(99, currentLevel)); // Ensure level is between 1-99
                        }
                    }
                }
                
                console.warn(`Could not find skill level for: ${skillName}`);
                return 1; // Default to level 1 if not found
            } catch (error) {
                console.error('Error getting skill level:', error);
                return 1;
            }
        }

        /**
         * Confirm adding the item to To-Do list
         */
        async function confirmAddToTodo() {
            if (!currentModalData) return;

            const { type, itemId, difficulty, taskIndex } = currentModalData;
            
            try {
                // Create a goal object to add to the master list
                let newGoal = null;

                if (type === 'quest') {
                    const quest = typeof QUESTS_DATABASE !== 'undefined' ? QUESTS_DATABASE[itemId] : null;
                    if (quest) {
                        const requiredItems = extractRequiredItems(quest.requirements || []);
                        const requiredSkills = extractRequiredSkills(quest.requirements || []);
                        
                        newGoal = {
                            id: `quest_${itemId}`,
                            name: quest.name,
                            category: quest.miniquest ? 'Miniquest' : 'Quest',
                            difficulty: quest.difficulty,
                            requiredItems: requiredItems,
                            requiredSkills: requiredSkills,
                            questPoints: quest.quest_points
                        };
                    }
                } else if (type === 'diary') {
                    const diary = window.ACHIEVEMENT_DIARIES_DATABASE ? 
                                  Object.values(window.ACHIEVEMENT_DIARIES_DATABASE).find(d => d.id === itemId) : null;
                    if (diary && diary.difficulties && diary.difficulties[difficulty] && 
                        diary.difficulties[difficulty].tasks[taskIndex]) {
                        const task = diary.difficulties[difficulty].tasks[taskIndex];
                        const requiredItems = extractRequiredItems([task.description]);
                        const requiredSkills = extractRequiredSkills([task.description]);
                        
                        newGoal = {
                            id: `diary_${itemId}_${difficulty}_${taskIndex}`,
                            name: `${diary.name} - ${difficulty}: ${task.description}`,
                            category: 'Achievement Diary',
                            difficulty: difficulty,
                            requiredItems: requiredItems,
                            requiredSkills: requiredSkills,
                            region: diary.region
                        };
                    }
                } else if (type === 'skill') {
                    const skillName = itemId.charAt(0).toUpperCase() + itemId.slice(1);
                    const targetLevel = parseInt(document.getElementById('target-level').value) || 99;
                    
                    newGoal = {
                        id: `skill_goal_${itemId}_${targetLevel}`,
                        name: `Train ${skillName} to level ${targetLevel}`,
                        category: 'Skill Goal',
                        difficulty: 'custom',
                        requiredItems: [],
                        requiredSkills: [{ skill: skillName, level: targetLevel }]
                    };
                }

                if (newGoal) {
                    console.log('Creating new goal:', newGoal);
                    
                    // Check if goal already exists in database
                    const existingGoals = await getAllGoalsFromDB();
                    const existingGoal = existingGoals.find(goal => goal.id === newGoal.id);
                    
                    if (!existingGoal) {
                        // Goal doesn't exist in database, create it
                        masterGoalsList.push(newGoal);
                        await addGoalToDB(newGoal);
                        await saveGoalSelection(newGoal.id, true);
                        console.log(`Created and added "${newGoal.name}" to To-Do list`);
                        showToDoFeedback('Added to To-Do list!', 'success');
                    } else {
                        // Goal exists in database, just select it
                        if (!masterGoalsList.find(goal => goal.id === newGoal.id)) {
                            masterGoalsList.push(existingGoal);
                        }
                        await saveGoalSelection(newGoal.id, true);
                        console.log(`Selected existing "${newGoal.name}" for To-Do list`);
                        showToDoFeedback('Added to To-Do list!', 'success');
                    }
                    
                    // Refresh the goals display if we're on the todo tab
                    if (document.getElementById('todo-tab').classList.contains('active')) {
                        await populateGoalsList();
                    }
                    
                    // Update requirements after adding goal
                    await updateRequirements();
                    
                    // Update button state
                    updateButtonState(type, itemId, difficulty, taskIndex, true, newGoal.id);
                }

            } catch (error) {
                console.error('Error adding to To-Do list:', error);
                showToDoFeedback('Error adding to To-Do list', 'error');
            }

            // Close the modal
            closeTodoModal();
        }

        /**
         * Update button state to show it's been added
         */
        function updateButtonState(type, itemId, difficulty, taskIndex, added) {
            // Find and update the button
            let buttonSelector = '';
            if (type === 'quest') {
                buttonSelector = `button[onclick*="openTodoModal('quest', '${itemId}')"]`;
            } else if (type === 'diary') {
                buttonSelector = `button[onclick*="openTodoModal('diary', '${itemId}', '${difficulty}', ${taskIndex})"]`;
            } else if (type === 'skill') {
                buttonSelector = `button[onclick*="openTodoModal('skill', '${itemId}')"]`;
            }

            const button = document.querySelector(buttonSelector);
            if (button) {
                if (added) {
                    button.classList.add('added');
                    button.textContent = button.textContent.replace('+ To-Do', 'Added').replace('+', 'âœ“');
                    // Store which goal this button corresponds to
                    button.setAttribute('data-goal-id', arguments[5] || ''); // Pass goal ID as 6th argument
                } else {
                    button.classList.remove('added');
                    button.textContent = button.textContent.replace('Added', '+ To-Do').replace('âœ“', '+');
                    button.removeAttribute('data-goal-id');
                }
            }
        }

        /**
         * Show feedback message
         */
        function showToDoFeedback(message, type) {
            // Create temporary feedback element
            const feedback = document.createElement('div');
            feedback.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#28a745' : type === 'warning' ? '#ffc107' : '#dc3545'};
                color: white;
                padding: 15px 20px;
                border-radius: 5px;
                font-family: 'Cinzel', serif;
                font-weight: bold;
                z-index: 1001;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                animation: slideIn 0.3s ease-out;
            `;
            feedback.textContent = message;

            // Add CSS animation
            if (!document.getElementById('feedback-styles')) {
                const style = document.createElement('style');
                style.id = 'feedback-styles';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
            }

            document.body.appendChild(feedback);

            // Remove after 3 seconds
            setTimeout(() => {
                if (feedback.parentNode) {
                    feedback.parentNode.removeChild(feedback);
                }
            }, 3000);
        }

        /**
         * Add To-Do buttons to all stat items dynamically
         */
        function addStatsButtons() {
            const statItems = document.querySelectorAll('.stat-item');
            const skillNames = [
                'attack', 'strength', 'defence', 'ranged', 'prayer', 'magic', 'runecraft', 'construction',
                'hitpoints', 'agility', 'herblore', 'thieving', 'crafting', 'fletching', 'slayer', 'hunter',
                'mining', 'smithing', 'fishing', 'cooking', 'firemaking', 'woodcutting', 'farming'
            ];

            statItems.forEach((item, index) => {
                if (index < skillNames.length) {
                    const skillName = skillNames[index];
                    
                    // Check if button already exists
                    if (!item.querySelector('.add-to-todo-btn-small')) {
                        const button = document.createElement('button');
                        button.className = 'add-to-todo-btn add-to-todo-btn-small';
                        button.textContent = '+';
                        button.onclick = () => openTodoModal('skill', skillName);
                        item.appendChild(button);
                    }
                }
            });
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('todo-modal');
            if (event.target === modal) {
                closeTodoModal();
            }
            
            const removeModal = document.getElementById('remove-modal');
            if (event.target === removeModal) {
                closeRemoveModal();
            }
        });
        

        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeTodoModal();
                closeRemoveModal();
            }
        });


        /**
         * Reset button state when goal is removed
         * @param {string} goalId - The ID of the removed goal
         */
        function resetButtonState(goalId) {
            // First, try to find button by stored goal ID
            const buttonWithGoalId = document.querySelector(`button[data-goal-id="${goalId}"]`);
            if (buttonWithGoalId) {
                buttonWithGoalId.classList.remove('added');
                buttonWithGoalId.textContent = buttonWithGoalId.textContent.replace('Added', '+ To-Do').replace('âœ“', '+');
                buttonWithGoalId.removeAttribute('data-goal-id');
                return;
            }

            // Fallback to parsing goal ID (for older goals without data-goal-id)
            if (goalId.startsWith('quest_')) {
                const questId = goalId.replace('quest_', '');
                updateButtonState('quest', questId, null, null, false);
            } else if (goalId.startsWith('diary_')) {
                // For diary goals, we need to parse the full ID
                const parts = goalId.replace('diary_', '').split('_');
                if (parts.length >= 3) {
                    const diaryId = parts[0];
                    const difficulty = parts[1];
                    const taskIndex = parts[2];
                    updateButtonState('diary', diaryId, difficulty, taskIndex, false);
                }
            } else if (goalId.startsWith('skill_goal_')) {
                const skillName = goalId.replace('skill_goal_', '').split('_')[0];
                updateButtonState('skill', skillName, null, null, false);
            }
        }

        // Initialize stats buttons when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(addStatsButtons, 500);
        });

        // Expose functions to global scope for debugging
        window.populateMasterGoalsList = populateMasterGoalsList;
        window.initializeToDoTab = initializeToDoTab;
        window.masterGoalsList = masterGoalsList;
        window.openTodoModal = openTodoModal;
        window.closeTodoModal = closeTodoModal;
        window.confirmAddToTodo = confirmAddToTodo;
        window.openRemoveModal = openRemoveModal;
        window.closeRemoveModal = closeRemoveModal;
        window.confirmRemoveGoal = confirmRemoveGoal;
        window.getCurrentSkillLevel = getCurrentSkillLevel;
        window.updateButtonStateFromGoalId = updateButtonStateFromGoalId;
        window.recreateCustomSkillGoals = recreateCustomSkillGoals;
    </script>

    <!-- Add to To-Do List Modal -->
    <div id="todo-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add to To-Do List</h2>
                <button class="modal-close" onclick="closeTodoModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-item-info">
                    <h3 id="modal-item-name">Item Name</h3>
                    <p id="modal-item-description">Item description will appear here.</p>
                    <div id="modal-item-details"></div>
                </div>
                
                <!-- Skill Level Input (only shown for skills) -->
                <div id="skill-level-input" style="display: none;">
                    <label for="target-level" class="skill-level-label">Target Level:</label>
                    <div class="level-input-container">
                        <input type="number" id="target-level" min="1" max="99" value="99" class="level-input">
                        <span class="level-info">Current: <span id="current-level">1</span></span>
                    </div>
                </div>
                
                <p class="modal-question">Would you like to add this to your To-Do List?</p>
            </div>
            <div class="modal-footer">
                <button class="modal-button modal-cancel" onclick="closeTodoModal()">Cancel</button>
                <button class="modal-button modal-confirm" onclick="confirmAddToTodo()">Add to To-Do List</button>
            </div>
        </div>
    </div>
    
    <!-- Remove from To-Do List Modal -->
    <div id="remove-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Remove from To-Do List</h2>
                <button class="modal-close" onclick="closeRemoveModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-item-info">
                    <h3 id="remove-modal-item-name">Item Name</h3>
                    <p id="remove-modal-item-description">Item description will appear here.</p>
                </div>
                
                <p class="modal-question">Are you sure you want to remove this from your To-Do List?</p>
            </div>
            <div class="modal-footer">
                <button class="modal-button modal-cancel" onclick="closeRemoveModal()">Cancel</button>
                <button class="modal-button modal-confirm modal-remove" onclick="confirmRemoveGoal()">Remove from To-Do List</button>
            </div>
        </div>
    </div>
</body>
</html>